<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

  <style>
    .kundeninfo {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-weight: bold;
    }
    .row {
      display: flex;
    }
    .price {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .price > * {
      display: flex;
    }
  </style>


  </head>
  <body>
    <div class="bpe-angebot">


      <div>
        <img class="logo-icon" alt="" src="" />
      </div>

      <div>
        <img
          class="herstellerlogobild-icon"
          alt=""
          src=""
        />
      </div>

      <div class="kundeninfo">
        <div class="kundennameinput"></div>
        <div class="kundenadresseinput"></div>
        <div class="kundenstadtinput"></div>
      </div>

      <div class="nameunternehmenfeld"></div>
      <div class="namefirmafeld"></div>
      <div class="adressefeld"></div>

      <h1 class="angebot">Angebot</h1>

      <div class="offer-id row">
        <b>Angebotsnummer: </b>
        <div class="inputfeldangebotsnummer"></div>
      </div>
      <div class="created row">
        <b>Angebotsdatum:</b>
        <div class="inputfelddatumab"></div>
      </div>
      <div class="expires row">
        <b>Gültig bis:</b>
        <div class="inputfeldgueltigbis"></div>
      </div>
      <div class="owner-id row">
        <b>Kundennummer</b>
        <div class="k93232">K93232</div>
      </div>

      <p>
        Unsere digitale Analyse hat folgendes Energiekonzept für Sie
        ergeben:
      </p>



      <div class="listeangebotsuebersicht"></div>



      <div class="price">
        <h2 class="preisbersicht">Preisübersicht</h2>
        <div>
          <div class="zwischensumme">Zwischensumme</div>
          <div class="herstellerbruttobeitrag"></div>
        </div>
        <div>
          <div class="rabatt-2000"></div>
          <div class="herstellerrabatt"></div>
        </div>
        <div>
          <div class="nettobetrag1">Nettobetrag</div>
          <div class="herstellernettobeitrag"></div>
        </div>
        <div>
          <div class="ust-1900"></div>
          <div class="herstellerust"></div>
        </div>
        <div style="width: 50%;">
          <hr style="width: 100%;">
        </div>
        <div>
          <div class="gesamt">Gesamt</div>
          <div class="herstellergesamtpreis"></div>
        </div>
      </div>


      <div class="begruessung">
        <p>Sehr geehrte/r Kundin/Kunde,</p>
        <p>
          wir sind Ihnen schon jetzt für Ihr Vertrauen und Ihr Interesse an
          unserem BPE-Solar Hybrid System, zur Erzielung einer autarken
          Energierevolution, dankbar. Mit der BPE-Hybrid-Energie-Lösung
          profitieren Sie von kostenloser Umweltwärme und einem
          unvergleichlichen Heizkomfort in Bezug auf Ihr Auftragsobjekt.
          Unsere innovative Wärmepumpe ermöglicht es, in kälteren Perioden als
          Heizsystem und an heißen Tagen als Kühlgerät zu wirken.
        </p>
        <p>
          Es handelt sich hierbei lediglich um ein Angebot. Wollen Sie das
          Angebot annehmen, entsteht erst ein Vertrag, nachdem der Bauleiter
          die Anfrage zu Ihrer Sicherheit geprüft hat.
        </p>

      </div>


      <div class="sign"></div>


      <div class="terms">
        <p>Bitte beachten:</p>
        <p>
          Befindet sich die Stellfläche des Gerüsts auf einem öffentlichen
          Gehweg, muss der Kunde die Genehmigung vorerst bei der Stadt
          beantragen. Bei einer Freileitung muss der Kunde die Isolierung der
          Stromführung zur Freileitung beim Netzbetreiber vor der Installation
          beantragen. Wenn das Gebäude Denkmal- oder Ensemblegeschützt ist,
          muss der Kunde den Bau eines Energiesystems vorerst bei der Stadt
          beantragen. Existiert kein W-Lan Signal in der Nähe des
          Stromspeichers, muss der Kunde eine Internetverbindung ermöglichen.
          Befindet sich vor Ort kein Hausanschlusskasten (HAK), muss der Kunde
          diesen vorerst von einer Fachfirma installieren lassen. Bei mehr als
          3 Stromzählern muss der Kunde ein, von diesem Angebot unabhängiges,
          zusätzliches Angebot für ein individuelles Zählerkonzept anfragen.
          Besitzt der Kunde keine Ersatzziegel ist es seine Aufgabe, diese zu
          besorgen. Will der Kunde die Module nicht auf dem Haus anbringen, in
          dem der Speicher ist, müssen die Erdarbeiten im Vorfeld vom Kunden
          erledigt werden.
        </p>
      </div>


  <script type="module">

    import {Request} from "../../../../../js/Request.js"
    import {DivField} from "../../../../../js/DivField.js"
    import {Helper} from "../../../../../js/Helper.js"

    const localStorageId = Request.localStorageId()
    const urlId = window.location.pathname.split("/")[4]

    const getOffer = {}
    getOffer.url = window.__DB_LOCATION__ + "/"
    getOffer.type = "offer"
    getOffer.name = "bestprime"
    getOffer.localStorageId = localStorageId
    getOffer.urlId = urlId
    getOffer.method = "get"
    getOffer.security = "closed"
    const res = await Request.middleware(getOffer)

    const offer = JSON.parse(res.response)

    const created_at = Helper.millisToDateString(offer.created_at)
    const expires_at = Helper.millisToDateString(offer.expires_at)

    document.querySelectorAll("img[class*='logo-icon']").forEach(img => {
      img.src = `/felix/shs/img/shslogo.png`
      img.alt = "SHS Energie Express Logo"
    })
    document.querySelectorAll("img[class*='herstellerlogobild-icon']").forEach(img => {
      img.src = `/felix/shs/hersteller/public/${offer.assets.logo}`
      img.alt = "Hersteller Logo Bestprime GmbH"
    })

    document.querySelectorAll("div[class*='nameunternehmenfeld']").forEach(field => {
      field.innerHTML = offer.from.company
    })
    document.querySelectorAll("div[class*='namefirmafeld']").forEach(field => field.innerHTML = offer.from.sector)
    document.querySelectorAll("div[class*='adressefeld']").forEach(field => field.innerHTML = `${offer.from.street} ${offer.from.houseNumber} • ${offer.from.zip} • ${offer.from.city}`)

    document.querySelectorAll("div[class*='inputfeldangebotsnummer']").forEach(field => {
      field.style.marginLeft = "21px"
      field.innerHTML = offer.id
    })
    document.querySelectorAll("div[class*='inputfelddatumab']").forEach(field => {
      field.style.marginLeft = "35px"
      field.innerHTML = created_at
    })
    document.querySelectorAll("div[class*='inputfeldgueltigbis']").forEach(field => {
      field.style.marginLeft = "78px"
      field.innerHTML = expires_at
    })
    document.querySelectorAll("div[class*='k93232']").forEach(field => {
      field.style.marginLeft = "35px"
      field.innerHTML = Helper.substring(urlId, 13)
    })

    document.querySelectorAll("div[class*='kundennameinput']").forEach(field => field.innerHTML = `${offer.to.firstName} ${offer.to.lastName}` )
    document.querySelectorAll("div[class*='kundenadresseinput']").forEach(field => field.innerHTML = offer.to.street)
    document.querySelectorAll("div[class*='kundenstadtinput']").forEach(field => field.innerHTML = offer.to.zip)

    document.querySelectorAll("div[class*='listeangebotsuebersicht']").forEach(field => {
      field.innerHTML = ""
      field.style.margin = "34px 0"

      for (let i = 0; i < offer.options.length; i++) {
        const div = document.createElement("div")
        div.classList.add(`option-${i}`)
        div.style.position = "relative"
        div.style.height = "23px"
        if (i % 2) div.style.backgroundColor = "#e7e7e8"

        const amount = document.createElement("div")
        amount.classList.add(`amount`)
        amount.innerHTML = `${offer.options[i].amount}x`
        amount.style.position = "absolute"
        amount.style.top = "0"
        amount.style.left = "0"

        const title = document.createElement("div")
        title.classList.add(`gy-title`)
        const substring = Helper.substring(offer.options[i].title, 21)
        title.innerHTML = substring
        title.title = offer.options[i].title
        title.style.position = "absolute"
        title.style.top = "0"
        title.style.left = "10%"

        const price = document.createElement("div")
        price.classList.add(`price`)
        price.innerHTML = `${offer.options[i].price.toFixed(2)} €`
        price.style.position = "absolute"
        price.style.top = "0"
        price.style.right = "15%"

        const input = document.createElement("input")
        input.type = "checkbox"
        input.classList.add(`checkbox`)
        input.checked = offer.options[i].selected
        input.style.position = "absolute"
        input.style.top = "0"
        input.style.right = "5%"
        input.addEventListener("input", (event) => {
          offer.options[i].selected = event.target.checked

          // render price
          const price = Helper.sumSelectedPrice(offer.options)
          herstellerbruttobeitrag.withType(div => div.innerHTML = `${price.toFixed(2).replace(".", ",")} €`)
          herstellerrabatt.withType(div => div.innerHTML = `${(price * offer.discount).toFixed(2).replace(".", ",")} €`)
          herstellernettobeitrag.withType(div => div.innerHTML = `${(price - price * offer.discount).toFixed(2).replace(".", ",")} €`)
          herstellerust.withType(div => div.innerHTML = `${(price * offer.vat).toFixed(2).replace(".", ",")} €`)
          herstellergesamtpreis.withType(div => div.innerHTML = `${((price - price * offer.discount) + (price * offer.vat)).toFixed(2).replace(".", ",")} €`)

        })

        div.append(amount, title, price, input)
        field.append(div)
      }
    })

    // render price
    const price = Helper.sumSelectedPrice(offer.options)
    const herstellerbruttobeitrag = new DivField("div[class*='herstellerbruttobeitrag']")
    .withType(div => {
      div.style.marginLeft = "55px"
      div.style.fontWeight = "bold"
      div.innerHTML = `${price.toFixed(2).replace(".", ",")} €`
    })
    const discount = new DivField("div[class*='rabatt-2000']")
    .withType(div => div.innerHTML = `Rabatt ${(offer.discount * 100).toFixed(2).replace(".", ",")}%`)
    const herstellerrabatt = new DivField("div[class*='herstellerrabatt']")
    .withType(div => {
      div.style.marginLeft = "62px"
      div.style.fontWeight = "bold"
      div.innerHTML = `${(price * offer.discount).toFixed(2).replace(".", ",")} €`
    })
    const herstellernettobeitrag = new DivField("div[class*='herstellernettobeitrag']")
    .withType(div => {
      div.style.marginLeft = "55px"
      div.style.fontWeight = "bold"
      div.innerHTML = `${(price - price * offer.discount).toFixed(2).replace(".", ",")} €`
    })
    const ust = new DivField("div[class*='ust-1900']")
    .withType(div => div.innerHTML = `USt. ${(offer.vat * 100).toFixed(2).replace(".", ",")}%`)
    const herstellerust = new DivField("div[class*='herstellerust']")
    .withType(div => {
      div.style.marginLeft = "62px"
      div.style.fontWeight = "bold"
      div.innerHTML = `${(price * offer.vat).toFixed(2).replace(".", ",")} €`
    })
    const herstellergesamtpreis = new DivField("div[class*='herstellergesamtpreis']")
    .withType(div => {
      div.style.marginLeft = "55px"
      div.style.fontWeight = "bold"
      div.innerHTML = `${((price - price * offer.discount) + (price * offer.vat)).toFixed(2).replace(".", ",")} €`
    })

    const signField = new DivField("div[class*='sign']")
    .withType(div => {
      div.style.marginTop = "89px"
      div.innerHTML = /*html*/`
        <p>..........................................................................</p>
        <p>Unterschrift ${offer.to.firstName} ${offer.to.lastName}</p>
      `
    })

    window.print()

  </script>

  <script id="__EXPOSE__">
    window.__AUTH_LOCATION__="http://localhost:10003"
    window.__DB_LOCATION__="http://localhost:10001"
    document.getElementById("__EXPOSE__").remove()
  </script>
</body>


</html>
