<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="shortcut icon" href="/public/getyour-logo.svg" />
    <title>Energie Portal - Neuen Kunden anlegen</title>


    <style>
      body {
        margin: 0;
        line-height: 1.2;
        font-family: sans-serif;
        padding-bottom: 144px;
      }
    </style>


  </head>
  <body>


    <header></header>

    <h1 class="personal-title"></h1>
    <div class="info"></div>

    <div class="firstname"></div>
    <div class="lastname"></div>
    <div class="street"></div>
    <div class="zip"></div>
    <div class="country"></div>
    <div class="state"></div>
    <div class="phone"></div>
    <div class="email"></div>


    <div class="save-and-proceed-button"></div>
    <div class="info-under-button"></div>

    <footer></footer>


    <script type="module">
      import { HeaderField } from "/js/HeaderField.js"
      import { InfoField } from "/js/InfoField.js"
      import { DivField } from "/js/DivField.js"
      import { TextField } from "/js/TextField.js"
      import { TelField } from "/js/TelField.js"
      import { PasswordField } from "/js/PasswordField.js"
      import { Helper } from "/js/Helper.js"
      import { SelectionField } from "/js/SelectionField.js"
      import { EmailField } from "/js/EmailField.js"
      import { Request } from "/js/Request.js"

      const header = document.querySelector("header")
      header.style.position = "fixed"
      header.style.bottom = "0"
      header.style.left = "0"
      header.style.backgroundColor = "white"
      header.style.width = "100%"
      header.style.display = "flex"
      header.style.flexWrap = "wrap"
      header.style.alignItems = "center"
      header.style.justifyContent = "space-between"
      header.style.boxShadow = "0 -3px 5px rgba(0, 0, 0, 0.13)"
      header.style.zIndex = "1"

      const leftContainer = document.createElement("div")
      leftContainer.style.display = "flex"
      leftContainer.style.alignItems = "center"
      leftContainer.style.flexWrap = "wrap"

      const logo = document.createElement("img")
      logo.src = "/felix/shs/public/ep-logo.svg"
      logo.alt = "Energie Portal"
      logo.style.width = "55px"
      logo.style.margin = "21px 0 21px 34px"
      logo.style.cursor = "pointer"
      logo.addEventListener("click", () => window.history.back())
      leftContainer.append(logo)

      const name = document.createElement("div")
      name.innerHTML = "Energie Portal"
      name.style.margin = "0 34px"
      name.style.fontSize = "21px"
      name.style.color = "#7bc043"
      leftContainer.append(name)
      header.append(leftContainer)

      document.querySelectorAll(".personal-title").forEach(title => {
        title.innerHTML = "Neuen Kunden anlegen"
        title.style.margin = "21px 34px"
        title.style.fontWeight = "normal"
      })

      const infoField = new InfoField("info")
      .withSuccess("Schnell und Einfach die Daten deines Kunden sichern.")
      .withType(info => info.style.fontSize = "21px")
      .build()

















      const firstnameField = new TextField("firstname")
      .withLabel(label => label.innerHTML = "Vorname")
      .withType(text => {
        text.placeholder = "Max"
        text.required = true
      })
      .onInput(async() => {
        firstnameField.withStorage(value => {
          window.sessionStorage.setItem("firstname", value)
        })
      })
      .fromStorage((name) => window.sessionStorage.getItem(name))
      firstnameField.withStorage(value => {
        window.sessionStorage.setItem("firstname", value)
      })


      const lastnameField = new TextField("lastname")
      .withLabel(label => label.innerHTML = "Nachname")
      .withType(text => {
        text.placeholder = "Muster"
        text.required = true
      })
      .onInput(async() => {
        lastnameField.withStorage(value => {
          window.sessionStorage.setItem("lastname", value)
        })
      })
      .fromStorage((name) => window.sessionStorage.getItem(name))
      lastnameField.withStorage(value => {
        window.sessionStorage.setItem("lastname", value)
      })


      const streetField = new TextField("street")
      .withLabel(label => label.innerHTML = "Straße und Hausnummer")
      .withType(text => {
        text.placeholder = "Wiesentalstr. 43"
        text.required = true
      })
      .onInput(async() => {
        streetField.withStorage(value => {
          window.sessionStorage.setItem("street", value)
        })
      })
      .fromStorage((name) => window.sessionStorage.getItem(name))
      streetField.withStorage(value => {
        window.sessionStorage.setItem("street", value)
      })



      const zipField = new TextField("zip")
      .withLabel(label => label.innerHTML = "Postleitzahl und Stadt")
      .withType(text => {
        text.placeholder = "70190 Stuttgart"
        text.required = true
      })
      .onInput(async() => {
        zipField.withStorage(value => {
          window.sessionStorage.setItem("zip", value)
        })
      })
      .fromStorage((name) => window.sessionStorage.getItem(name))
      zipField.withStorage(value => {
        window.sessionStorage.setItem("zip", value)
      })



      const stateField = new SelectionField("state")
      .withLabel(label => label.innerHTML = "Bundesland oder Kanton")
      .withOptions(["Baden-Württemberg", "Bayern", "Berlin", "Brandenburg", "Bremen", "Hamburg", "Hessen", "Mecklenburg-Vorpommern", "Niedersachsen", "Nordrhein Westfalen", "Rheinland-Pfalz", "Saarland", "Sachsen", "Sachsen-Anhalt", "Schleswig-Holstein", "Thüringen", "Burgenland", "Kärnten", "Niederösterreich", "Oberösterreich", "Salzburg", "Steiermark", "Tirol", "Vorarlberg", "Wien", "Aargau", "Appenzell Ausserrhoden", "Appenzell Innerrhoden", "Basel-Land", "Basel-Stadt", "Bern", "Fribourg Freiburg", "Genève Geneva", "Glarus", "Graubünden Grischuns Grigioni", "Jura", "Luzern Lucerne", "Neuchâtel", "Nidwalden", "Obwalden", "St.Gallen", "Schaffhausen", "Schwyz", "Solothurn", "Thurgau", "Ticino", "Uri", "Vaud", "Valais Wallis", "Zug", "Zürich"])
      .onInput(async() => {
        stateField.withStorage(value => {
          window.sessionStorage.setItem("state", value[0])
        })
      })
      .fromStorage((name) => [window.sessionStorage.getItem(name)])
      stateField.withStorage(value => {
        window.sessionStorage.setItem("state", value[0])
      })


      const countryField = new SelectionField("country")
      .withLabel(label => label.innerHTML = "Land")
      .withOptions(["Deutschland", "Österreich", "Schweiz"])
      .onWindowLoad(async event => await changeState())
      .onChange(async event => await changeState())
      .onInput(async() => {
        countryField.withStorage(value => {
          window.sessionStorage.setItem("country", value[0])
        })
      })
      .fromStorage((name) => [window.sessionStorage.getItem(name)])
      countryField.withStorage(value => {
        window.sessionStorage.setItem("country", value[0])
      })

      const phoneField = new TelField("phone")
      .withLabel(label => label.innerHTML = "Telefon")
      .withType(tel => {
        tel.placeholder = "+49 153 1223 1111"
        tel.required = true
      })
      .onInput(async() => {
        phoneField.withStorage(value => {
          window.sessionStorage.setItem(phoneField.name, value)
        })
      })
      .fromStorage((name) => window.sessionStorage.getItem(name))
      phoneField.withStorage(value => {
        window.sessionStorage.setItem(phoneField.name, value)
      })


      const emailField = new EmailField("email")
      .withLabel(label => label.innerHTML = "E-Mail Adresse")
      .withType(email => {
        email.placeholder = "max.mustermann@web.de"
        email.required = true
      })
      .onInput(async() => {
        emailField.withStorage(value => {
          window.sessionStorage.setItem(emailField.name, value)
        })
      })
      .fromStorage((name) => window.sessionStorage.getItem(name))
      emailField.withStorage(value => {
        window.sessionStorage.setItem(emailField.name, value)
      })


      const speichernundweiterbutton = new DivField("save-and-proceed-button")
      .withType(div => {
        div.innerHTML = "Jetzt anlegen"
        div.style.fontSize = "21px"
        div.style.margin = "144px 34px 0 34px"
        div.style.backgroundColor = "#f7aa20"
        div.style.borderRadius = "13px"
        div.style.height = "89px"
        div.style.display = "flex"
        div.style.justifyContent = "center"
        div.style.alignItems = "center"
        div.addEventListener("mouseover", () => div.style.backgroundColor = "#f19d08")
        div.addEventListener("mouseout", () => div.style.backgroundColor = "#f7aa20")
      })
      .onClick(async () => await checkAndProceed())


      async function checkAndProceed() {

        const email = await emailField.withValidValue()
        const firstname = await firstnameField.withValidValue()
        const lastname = await lastnameField.withValidValue()
        const street = await streetField.withValidValue()
        const zip = await zipField.withValidValue()
        const state = (await stateField.withValidValue())[0].value
        const country = (await countryField.withValidValue())[0].value
        const phone = await phoneField.withValidValue()



        await Request.withVerifiedEmail(email, async () => {

          // register new user
          // register id in the seller clients



          const registerEmail = {}
          registerEmail.url = "/register/email/onregister/"
          registerEmail.consumer = 4
          registerEmail.email = email
          registerEmail.firstname = firstname
          registerEmail.lastname = lastname
          registerEmail.street = street
          registerEmail.zip = zip
          registerEmail.country = country
          registerEmail.state = state
          registerEmail.password = passwordHash
          registerEmail.referer = document.referrer
          await Request.sequence(registerEmail)




          alert("Speichern erfolgreich..")
          window.sessionStorage.clear()
          window.history.back()
        })



      }




      async function changeState() {
        const options = await countryField.withValidValue()
        if (options[0].value === "Deutschland") {
          stateField.withOptions(["Baden-Württemberg", "Bayern", "Berlin", "Brandenburg", "Bremen", "Hamburg", "Hessen", "Mecklenburg-Vorpommern", "Niedersachsen", "Nordrhein Westfalen", "Rheinland-Pfalz", "Saarland", "Sachsen", "Sachsen-Anhalt", "Schleswig-Holstein", "Thüringen"])
        }
        if (options[0].value === "Österreich") {
          stateField.withOptions(["Burgenland", "Kärnten", "Niederösterreich", "Oberösterreich", "Salzburg", "Steiermark", "Tirol", "Vorarlberg", "Wien"])
        }
        if (options[0].value === "Schweiz") {
          stateField.withOptions(["Aargau", "Appenzell Ausserrhoden", "Appenzell Innerrhoden", "Basel-Land", "Basel-Stadt", "Bern", "Fribourg Freiburg", "Genève Geneva", "Glarus", "Graubünden Grischuns Grigioni", "Jura", "Luzern Lucerne", "Neuchâtel", "Nidwalden", "Obwalden", "St.Gallen", "Schaffhausen", "Schwyz", "Solothurn", "Thurgau", "Ticino", "Uri", "Vaud", "Valais Wallis", "Zug", "Zürich"])
        }
        stateField.withStorage(options => {
          window.sessionStorage.setItem(stateField.name, options[0])
        })
      }


    </script>

  </body>
</html>
