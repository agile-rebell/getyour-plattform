<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <title>SHS Funnel</title>


    <style>
      body {
        margin: 0;
        line-height: 1.2;
        font-family: sans-serif;
      }
    </style>


  </head>
  <body>


    <header></header>

    <h1 class="power-system-title"></h1>
    <div class="power-system-funnel"></div>

    <h2 class="picture-upload-title"></h2>
    <div class="picture-upload-funnel"></div>

    <div class="save-and-proceed-button"></div>

    <footer></footer>


    <script type="module">
      import { HeaderField } from "../../../../js/HeaderField.js"
      import { FunnelField } from "../../../../js/FunnelField.js"
      import { CheckboxField } from "../../../../js/CheckboxField.js"
      import { DivField } from "../../../../js/DivField.js"
      import { FileField } from "../../../../js/FileField.js"
      import { Helper } from "../../../../js/Helper.js"
      import { NumberField } from "../../../../js/NumberField.js"
      import { SelectionField } from "../../../../js/SelectionField.js"


      const funnel = Helper.getFunnelByStorageName("shsFunnel")
      // if (funnel === undefined) {
      //   window.location.assign("/felix/shs/funnel/qualifizierung/")
      //   throw new Error("funnel not found")
      // }

      const headerField = new HeaderField()
      .withImage(img => {
        img.src = "../../public/shslogo.png"
        img.alt = "SHS Express Logo"
        img.style.cursor = "pointer"
        img.style.width = "144px"
        img.addEventListener("click", async() => await Helper.redirectOperatorToChecklist())
      })
      .withType(header => {
        header.style.position = "fixed"
        header.style.top = "0"
        header.style.left = "0"
        header.style.zIndex = "1"
        header.style.backgroundColor = "white"
      })
      .withNavigation([
        {active: true, name: "Haus", onclick: async() => await checkAndProceed(funnel.path.house)},
        {active: true, name: "Heizung", onclick: async() => await checkAndProceed(funnel.path.heating)},
        {active: true, name: "Strom", onclick: async() => await checkAndProceed(funnel.path.electricity)},
        {active: false, name: "Technisches", onclick: async() => await checkAndProceed(funnel.path.technical)}
      ])
      .build()

      document.querySelectorAll(".power-system-title").forEach(title => {
        title.innerHTML = "Stromanlage"
        title.style.margin = "377px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })


      const powerSystemFunnel = new FunnelField("power-system-funnel")
      .withFields([
        {class: "stromVersorger", type: "text", withLabel: "Aktueller Stromversorger", withType: stromVersorgerOptions},
        {class: "stromZaehlerschrankVerbaut", type: "select", withLabel: "Geeigneter Zählerschrank verbaut", onWindowLoad: stromZaehlerschrankVerbautOnWindowLoad, onChange: stromZaehlerschrankVerbautOnChange, withOptions: ["Nein", "Ja"]},
        {class: "stromPlatzZaehlerSchrank", type: "select", withLabel: "Platz für zusätzlichen, neuen Zählerschrank (600x1100mm) vorhanden", withOptions: ["Nein", "Ja"], withRequired: 1},
        {class: "stromHauptzaehlerAnzahl", type: "select", withLabel: "Anzahl der Stromzähler", withOptions: ["1", "2", "3", "mehr"]},
        {class: "stromUnterzaehlerNotwendig", type: "select", withLabel: "Zusätzlicher Unter-/Zwischenzähler notwendig", withOptions: ["Nein", "Ja"], onWindowLoad: stromUnterzaehlerNotwendigOnWindowLoad, onChange: stromUnterzaehlerNotwendigOnChange},
        {class: "stromWievieleNeueZaehler", type: "select", withLabel: "Wie viele zusätzliche Zähler", withOptions: ["1", "2", "3"]},
        {class: "stromHauptzaehlerNummer", type: "text", withLabel: "Zählernummer Hauptzähler", withType: hauptZahlerOption},
        {class: "stromNebenzaehlerNummer", type: "text", withLabel: "Zählernummer Nebenzähler", withType: nebenZahlerOption},
        {class: "stromZaehlerKonzeptZusammen", type: "select", withLabel: "Sollen alle Stromzähler auf einen Stromzähler zusammengelegt werden", withOptions: ["Nein", "Ja", "E-Auto", "Wärmepumpe", "Pool", "Durchlauferhitzer", "Nachtspeicherheizung", "Sonstige"], withType: (select) => select.multiple = true},
        {class: "stromJahresverbrauch", type: "number", withLabel: "Jahresstromverbrauch Hauptzähler in kWh", withType: numberInKwh},
        {class: "stromNebenzaehlerFunktion", type: "number", withLabel: "2. Stromzähler, Zweck und Jahresstromverbrauch in kWh", withType: numberInKwh},
        {class: "stromArbeitspreis", type: "number", withLabel: "Arbeitspreis brutto Cent/kWh", withType: numberInCent},
        {class: "stromGrundpreis", type: "number", withLabel: "Grundpreis brutto/Jahr in Euro", withType: numberInEuro},
        {class: "stromArbeitspreisWaerme", type: "number", withLabel: "Wärmestrom Arbeitspreis brutto Cent/kWh", withType: numberInCent},
        {class: "stromaGrundpreisWaerme", type: "number", withLabel: "Wärmestrom Grundpreis brutto/Jahr in Euro", withType: numberInEuro},
      ])

      function numberInEuro(input) {
        input.min = 0
        input.max = 1000000
        input.placeholder = "in euro"
      }

      function numberInCent(input) {
        input.min = 0
        input.max = 1000000
        input.placeholder = "in cent"
      }

      function numberInKwh(input) {
        input.min = 0
        input.max = 1000000
        input.placeholder = "in kWh"
      }

      function nebenZahlerOption(input) {
        input.placeholder = "33104800"
      }

      function hauptZahlerOption(input) {
        input.placeholder = "44600637"
        const q7 = funnel.value.q7
        if (q7 === 0) {
          input.required = true
        }
      }


      const stromZaehlerschrankVerbautField = "[class='stromZaehlerschrankVerbaut']"
      const stromPlatzZaehlerschrankField = "[class='stromPlatzZaehlerSchrank']"

      const stromUnterzaehlerNotwendigField = "[class='stromUnterzaehlerNotwendig']"
      const stromWievieleNeueZaehlerField = "[class='stromWievieleNeueZaehler']"


      function stromVersorgerOptions(input) {
        input.placeholder = "zb Netze - BW.."
      }

      function stromUnterzaehlerNotwendigOnChange(event) {
        if (event.target.value === "Ja") {
          document.querySelectorAll(stromWievieleNeueZaehlerField).forEach(otherField => {
            otherField.withType(otherSelect => {
              otherSelect.disabled = false
            })
          })
        } else {
          document.querySelectorAll(stromWievieleNeueZaehlerField).forEach(otherField => {
            otherField.withType(otherSelect => {
              otherSelect.disabled = true
            })
          })
        }
      }


      function stromUnterzaehlerNotwendigOnWindowLoad(event) {
        document.querySelectorAll(stromUnterzaehlerNotwendigField).forEach(field => {
          field.withType(select => {
            if (select.value === "Nein") {
              document.querySelectorAll(stromWievieleNeueZaehlerField).forEach(otherField => {
                otherField.withType(otherSelect => {
                  otherSelect.disabled = true
                })
              })
            }
          })
        })
      }

      function stromZaehlerschrankVerbautOnWindowLoad(event) {
        document.querySelectorAll(stromZaehlerschrankVerbautField).forEach(field => {
          field.withType(select => {
            if (select.value === "Ja") {
              document.querySelectorAll(stromPlatzZaehlerschrankField).forEach(otherField => {
                otherField.withType(otherSelect => {
                  otherSelect.disabled = true
                })
              })
            }
          })
        })
      }

      function stromZaehlerschrankVerbautOnChange(event) {
        document.querySelectorAll(stromZaehlerschrankVerbautField).forEach(field => {
          field.withType(select => {
            if (select.value === "Ja") {
              document.querySelectorAll(stromPlatzZaehlerschrankField).forEach(otherField => {
                otherField.withType(otherSelect => {
                  otherSelect.disabled = true
                  otherField.withRequired(undefined)
                  otherField.withValidValue()
                })
              })
            } else {
              document.querySelectorAll(stromPlatzZaehlerschrankField).forEach(otherField => {
                otherField.withType(otherSelect => {
                  otherSelect.disabled = false
                  otherField.withRequired(1)
                  otherField.withValidValue()
                })
              })
            }
          })
        })
      }

      powerSystemFunnel.withStorage(funnel.storage).buildFields()







      document.querySelectorAll(".picture-upload-title").forEach(title => {
        title.innerHTML = "Bilder Upload"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })


      const pictureUploadFunnel = new FunnelField("picture-upload-funnel")
      .withFields([
        {class: "stromZaehlerschrankBild", type: "file", withLabel: label => label.innerHTML = "Kompletter Zählerschrank (gesamtes Innenleben)", withType: q7is0File},
        {class: "stromTypenBezeichnungBild", type: "file", withLabel: label => label.innerHTML = "Typenbezeichnung", withType: q7is0File},
        {class: "stromAllezaehlerBild", type: "file", withLabel: label => label.innerHTML = "Alle Zähler (Die Zählernummer sollte klar und deutlich lesbar sein)", withType: q7is0FileMultiple},
      ])


      function q7is0File(input) {
        input.accept = "image/*"
        const q7 = funnel.value.q7
        if (q7 === 0) {
          input.required = true
        }
      }

      function q7is0FileMultiple(input) {
        input.accept = "image/*"
        input.multiple = true
        const q7 = funnel.value.q7
        if (q7 === 0) {
          input.required = true
        }
      }

      pictureUploadFunnel.withStorage(funnel.storage).buildFields()




      const speichernundweiterbutton = new DivField("save-and-proceed-button")
      .withType(div => {
        div.innerHTML = "Speichern und weiter"
        div.style.fontSize = "21px"
        div.style.margin = "144px 34px"
        div.style.backgroundColor = "#f7aa20"
        div.style.borderRadius = "13px"
        div.style.height = "89px"
        div.style.display = "flex"
        div.style.justifyContent = "center"
        div.style.alignItems = "center"
        div.addEventListener("mouseover", () => div.style.backgroundColor = "#f19d08")
        div.addEventListener("mouseout", () => div.style.backgroundColor = "#f7aa20")
      })
      .onClick(async () => await checkAndProceed(funnel.path.technical))



      Helper.createSHSFooter()

      async function checkAndProceed(path) {
        await powerSystemFunnel.checkValidity()
        await pictureUploadFunnel.checkValidity()

        window.location.assign(path)
      }


    </script>

  </body>
</html>
