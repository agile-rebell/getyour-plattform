<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <title>SHS Funnel</title>


    <style>
      body {
        margin: 0;
        line-height: 1.2;
        font-family: sans-serif;
      }
    </style>


  </head>
  <body>


    <header></header>

    <h1 class="heating-title"></h1>
    <div class="heating-funnel"></div>

    <h2 class="heat-pump-title"></h2>
    <div class="heat-pump-funnel"></div>

    <h2 class="water-storage-title"></h2>
    <div class="water-storage-funnel"></div>

    <h2 class="power-storage-title"></h2>
    <div class="power-storage-funnel"></div>

    <h2 class="planning-title"></h2>
    <div class="planning-funnel"></div>

    <h2 class="meter-cabinet-title"></h2>
    <div class="meter-cabinet-funnel"></div>

    <div class="save-and-proceed-button"></div>

    <footer></footer>


    <script type="module">
      import { HeaderField } from "../../../../js/HeaderField.js"
      import { FunnelField } from "../../../../js/FunnelField.js"
      import { CheckboxField } from "../../../../js/CheckboxField.js"
      import { DivField } from "../../../../js/DivField.js"
      import { FileField } from "../../../../js/FileField.js"
      import { Helper } from "../../../../js/Helper.js"
      import { NumberField } from "../../../../js/NumberField.js"
      import { SelectionField } from "../../../../js/SelectionField.js"


      const funnel = Helper.getFunnelByStorageName("shsFunnel")
      // if (funnel === undefined) {
      //   window.location.assign("/felix/shs/funnel/qualifizierung/")
      //   throw new Error("funnel not found")
      // }

      const headerField = new HeaderField()
      .withImage(img => {
        img.src = "../../public/shslogo.png"
        img.alt = "SHS Express Logo"
        img.style.cursor = "pointer"
        img.style.width = "144px"
        img.addEventListener("click", async() => await Helper.redirectOperatorToChecklist())
      })
      .withType(header => {
        header.style.position = "fixed"
        header.style.top = "0"
        header.style.left = "0"
        header.style.zIndex = "1"
        header.style.backgroundColor = "white"
      })
      .withNavigation([
        {active: true, name: "Haus", onclick: async() => await checkAndProceed(funnel.path.house)},
        {active: true, name: "Heizung", onclick: async() => await checkAndProceed(funnel.path.heating)},
        {active: false, name: "Strom", onclick: async() => await checkAndProceed(funnel.path.electricity)},
        {active: false, name: "Technisches", onclick: async() => await checkAndProceed(funnel.path.technical)}
      ])
      .build()

      document.querySelectorAll(".heating-title").forEach(title => {
        title.innerHTML = "Heizungsanlage"
        title.style.margin = "377px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })


      const heatingFunnel = new FunnelField("heating-funnel")
      .withFields([
        {class: "heizungWomitHeizen", type: "select", withLabel: "Womit heizen Sie aktuell", withOptions: ["Erdgas", "Heizöl", "Wärmepumpe", "Holz/Kohle", "Pellets", "Flüssiggas", "Strom", "Andere"]},
        {class: "heizungWieHeizen", type: "select", withLabel: "Wie heizen Sie", withType: q9is0SelectDisabled, withOptions: ["Radiatoren/Konvektoren", "Flachheizkörper", "Fußboden-/Wandheizung", "Andere"]},
        {class: "heizungVorlauf", type: "number", withLabel: "Vorlauftemperatur ihrer Heizung (min)", withType: q9is0numberInGrad},
        {class: "heizungWarm", type: "select", withLabel: "Wie wird Warmwasser erzeugt", withOptions: ["Zentral über Heizung", "Separat (z.B. Durchlauferhitzer)", "Solarthermie", "Andere"]},
        {class: "heizungKosten", type: "number", withLabel: "Jährliche Heizkosten in EUR", withType: heizungKostenInput},
      ])


      function q9is0SelectDisabled(select) {
        select.disabled = true
        const q9 = funnel.value.q9
        if (q9 === 0) {
          select.disabled = false
        }
      }

      function q9is0numberInGrad(input) {
        input.disabled = true
        const q9 = funnel.value.q9
        if (q9 === 0) {
          input.disabled = false
          input.min = "0"
          input.max = "1000"
          input.placeholder = "in Grad"
          input.required = true
        }
      }

      function heizungKostenInput(input) {
        input.min = 0
        input.max = 1000000
        input.placeholder = "in Euro"
      }

      heatingFunnel.withStorage(funnel.storage).buildFields()



      document.querySelectorAll(".heat-pump-title").forEach(title => {
        title.innerHTML = "Aufstellungsort Wärmepumpe"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })

      const heatPumpFunnel = new FunnelField("heat-pump-funnel")
      .withFields([
        {class: "heizungWaermePumpeBild", type: "file", withLabel: label => label.innerHTML = "Die Wärmepumpe wird im Außenbereich aufgestellt", withType: q9is0FileRequired},
      ])

      function q9is0FileRequired(input) {
        input.disabled = true
        const q9 = funnel.value.q9
        if (q9 === 0) {
          input.disabled = false
          input.required = true
          input.accept = "image/*"
        }
      }

      heatPumpFunnel.withStorage(funnel.storage).buildFields()




      document.querySelectorAll(".water-storage-title").forEach(title => {
        title.innerHTML = "Aufstellungsort Wasserspeicher"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })

      const waterStorageFunnel = new FunnelField("water-storage-funnel")
      .withFields([
        {class: "heizungWasserSpeicherBild", type: "file", withLabel: label => label.innerHTML = "Eventuell Ort des vorhandenen Warmwasserspeichers", withType: q9is0FileRequired},
      ])

      waterStorageFunnel.withStorage(funnel.storage).buildFields()


      document.querySelectorAll(".power-storage-title").forEach(title => {
        title.innerHTML = "Aufstellungsort Stromspeicher"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })

      const powerStorageFunnel = new FunnelField("power-storage-funnel")
      .withFields([
        {class: "heizungStromSpeicherBild", type: "file", withLabel: label => label.innerHTML = "In der Nähe des Zählerschranks, höchstens 1 Etage unterschied", withType: q9is0FileRequired},
        {class: "heizungBetriebsTemperaturBekannt", type: "checkbox", withLabel: "Mir ist bekannt, dass die Betriebstemperatur des Speichers bei +5 bis 40 Grad liegt", afterCheckbox: "Ja, das ist mir bekannt.", withType: q8is0Required},
        {class: "heizungEintrittZehnMeter", type: "select", withLabel: "Beträgt die DC-Kabelführung von Hausantritt bis Speicher mehr als 10", withType: q7is0orQ8is0orQ9is0Disabled, withOptions: ["Nein", "Ja"]},
        {class: "heizungGleichesGebaeude", type: "select", withLabel: "Befinden sich die Module auf dem Haus, in dem der Speicher ist", withType: q7is0orQ8is0orQ9is0Disabled, withOptions: ["Ja", "Nein"]},
        {class: "heizungGleicherRaum", type: "select", withLabel: "Kann Speicher und WR Raum vom Zählerschrank montiert werden", withType: q7is0orq8is0DisabledSelect, withOptions: ["Ja", "Nein, 1 - 2 Räume entfernt", "Nein, mehr als 2 Räume entfernt"]},
        {class: "heizungMehrAlsZwanzigMeter", type: "select", withLabel: "Kabel vom Speicher bis Zähler mehr als 20m", withType: q7is0orq8is0DisabledSelect, withOptions: ["Nein", "20-30m", "30-40m", "40-50m", "mehr als 50m"]},
      ])

      function q7is0orq8is0DisabledSelect(select) {
        select.disabled = true
        const q7 = funnel.value.q7
        const q8 = funnel.value.q8
        if (q7 === 0 || q8 === 0) {
          select.disabled = false
        }
      }


      function q7is0orQ8is0orQ9is0Disabled(select) {
        select.disabled = true
        const q7 = funnel.value.q7
        const q8 = funnel.value.q8
        const q9 = funnel.value.q9
        if (q7 === 0 || q8 === 0 || q9 === 0) {
          select.disabled = false
        }
      }

      function q8is0Required(box) {
        box.disabled = true
        const q8 = funnel.value.q8
        if (q8 === 0) {
          box.disabled = false
          box.required = true
        }
      }

      powerStorageFunnel.withStorage(funnel.storage).buildFields()


      document.querySelectorAll(".planning-title").forEach(title => {
        title.innerHTML = "Etage des geplanten Speicher-/Wechselrichterstandort"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })

      const planningFunnel = new FunnelField("planning-funnel")
      .withFields([
        {class: "heizungSpeicherKellerEtage", type: "checkbox", withLabel: "Keller", withType: q7is0orq8is0Disabled},
        {class: "heizungSpeicherErsteEtage", type: "checkbox", withLabel: "Erdgeschoss", withType: q7is0orq8is0Disabled},
        {class: "heizungSpeicherZweiteEtage", type: "checkbox", withLabel: "2. Etage", withType: q7is0orq8is0Disabled},
        {class: "heizungSpeicherDritteEtage", type: "checkbox", withLabel: "3. Etage", withType: q7is0orq8is0Disabled},
      ])


      function q7is0orq8is0Disabled(box) {
        box.disabled = true
        const q7 = funnel.value.q7
        const q8 = funnel.value.q8
        if (q7 === 0 || q8 === 0) {
          box.disabled = false
        }
      }


      planningFunnel.withStorage(funnel.storage).buildFields()



      document.querySelectorAll(".meter-cabinet-title").forEach(title => {
        title.innerHTML = "Etage Ihres Zählerschranks"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })

      const meterCabinetFunnel = new FunnelField("meter-cabinet-funnel")
      .withFields([
        {class: "heizungZaehlerKellerEtage", type: "checkbox", withLabel: "Keller", withType: q7is0orq8is0Disabled},
        {class: "heizungZaehlerErsteEtage", type: "checkbox", withLabel: "Erdgeschoss", withType: q7is0orq8is0Disabled},
        {class: "heizungZaehlerZweiteEtage", type: "checkbox", withLabel: "2. Etage", withType: q7is0orq8is0Disabled},
        {class: "heizungZaehlerDritteEtage", type: "checkbox", withLabel: "3. Etage", withType: q7is0orq8is0Disabled},
      ])


      meterCabinetFunnel.withStorage(funnel.storage).buildFields()







      const speichernundweiterbutton = new DivField("save-and-proceed-button")
      .withType(div => {
        div.innerHTML = "Speichern und weiter"
        div.style.fontSize = "21px"
        div.style.margin = "144px 34px"
        div.style.backgroundColor = "#f7aa20"
        div.style.borderRadius = "13px"
        div.style.height = "89px"
        div.style.display = "flex"
        div.style.justifyContent = "center"
        div.style.alignItems = "center"
        div.addEventListener("mouseover", () => div.style.backgroundColor = "#f19d08")
        div.addEventListener("mouseout", () => div.style.backgroundColor = "#f7aa20")
      })
      .onClick(async () => await checkAndProceed(funnel.path.electricity))



      Helper.createSHSFooter()

      async function checkAndProceed(path) {
        await heatingFunnel.checkValidity()
        await heatPumpFunnel.checkValidity()
        await waterStorageFunnel.checkValidity()
        await powerStorageFunnel.checkValidity()
        await planningFunnel.checkValidity()
        await meterCabinetFunnel.checkValidity()

        window.location.assign(path)
      }


    </script>

  </body>
</html>
