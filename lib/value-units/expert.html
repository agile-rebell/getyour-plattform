<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <link rel="shortcut icon" href="/public/logo-getyour-red.svg">
    <title>Experte</title>

    <style>
      body {
        margin: 0;
        line-height: 1.2;
        font-family: sans-serif;
        padding-bottom: 144px;
        overscroll-behavior: none;
      }

      div.button:hover {
        outline: 3px solid #999;
      }
    </style>

  </head>
  <body>

    <script type="module">
      import {Helper} from "/js/Helper.js"

      document.body.style.background = Helper.colors.light.background
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.style.background = Helper.colors.dark.background
      }

      Helper.create("button/back", document.body)

      const app = Helper.create("button/app", document.body)
      Helper.render("icon/node/path", "/public/logo-getyour-red.svg", app)
      app.addEventListener("click", () => {

        Helper.overlay("popup", async overlay => {
          Helper.add("button/remove-overlay", overlay)
          const info = Helper.create("header/info", overlay)
          info.append(document.location.pathname)

          const content = Helper.create("info/loading", overlay)

          const ping = {}
          ping.url = "/verify/expert/closed/"
          const res = await Helper.request("location/json", ping)

          if (res.status === 200) {

            Helper.convert("parent/scrollable", content)

            Helper.add("button/start", content)
            Helper.add("button/update-expert-name", content)
            Helper.add("button/register-expert-platform", content)
            Helper.add("button/delete-self", content)

          }

          if (res.status !== 200) {
            Helper.convert("parent/navigation-open", content)
          }

        })

      })

      const title = Helper.render("text/title", "Plattformen", document.body)

      {
        const platformButtonsContainer = Helper.create("info/loading", document.body)

        if (window.localStorage.getItem("localStorageId") === null) {
          if (window.localStorage.getItem("email") === null) {

            const get = {}
            get.url = "/get/platforms/location/"
            const res = await Helper.request("location/json", get)

            if (res.status !== 200) {

              Helper.convert("parent/info", platformButtonsContainer)

              platformButtonsContainer.innerHTML = `<span style="margin: 21px 34px;">Schon bald werden hier Plattformen für dich zur Verfügung stehen.</span>`
              throw new Error("platform not found")

            }

            if (res.status === 200) {
              const platforms = JSON.parse(res.response)

              if (platforms.length === 0) {

                Helper.convert("parent/info", platformButtonsContainer)

                platformButtonsContainer.innerHTML = `<span style="margin: 21px 34px;">Schon bald werden hier Plattformen für dich zur Verfügung stehen.</span>`
                throw new Error("platform not found")

              }

              Helper.convert("parent/scrollable", platformButtonsContainer)

              Helper.render("platforms/location", platforms, platformButtonsContainer)

            }

          }
        }

        if (window.localStorage.getItem("localStorageId") !== null) {
          if (window.localStorage.getItem("email") !== null) {

            {
              const verify = {}
              verify.url = "/verify/expert/closed/"
              const res = await Helper.request("closed/json", verify)

              if (res.status !== 200) {

                const res = await Helper.get("platform-values/writability-closed")

                if (res.status === 200) {
                  const values = JSON.parse(res.response)

                  title.remove()
                  platformButtonsContainer.remove()

                  const overlay = Helper.create("div/overlay", document.body)

                  const searchField = Helper.create("field/text", overlay)
                  searchField.label.innerHTML = "Suche nach Alias"
                  searchField.input.placeholder = "Werteinheiten mit Schreibrechte"
                  Helper.verify("input/value", searchField.input)
                  Helper.add("outline-hover/node", searchField.input)

                  const buttons = Helper.create("div/scrollable", overlay)

                  searchField.input.oninput = (ev) => {
                    const filtered = values.filter(it => it.alias.toLowerCase().includes(ev.target.value.toLowerCase()))
                    const highlighted = filtered.map(it => {
                      const highlightedAlias = it.alias.replace(new RegExp(ev.target.value, 'i'), `<mark>${ev.target.value}</mark>`)
                      return { ...it, alias: highlightedAlias }
                    })
                    Helper.render("values/node/alias-path", highlighted, buttons)
                  }

                  Helper.render("values/node/alias-path", values, buttons)

                }

                if (res.status !== 200) {

                  const get = {}
                  get.url = "/get/platforms/location/"
                  const res = await Helper.request("location/json", get)

                  if (res.status !== 200) {

                    Helper.convert("parent/info", platformButtonsContainer)

                    platformButtonsContainer.innerHTML = `<span style="margin: 21px 34px;">Schon bald werden hier Plattformen für dich zur Verfügung stehen.</span>`
                    throw new Error("platform not found")

                  }

                  if (res.status === 200) {
                    const platforms = JSON.parse(res.response)

                    if (platforms.length === 0) {

                      Helper.convert("parent/info", platformButtonsContainer)

                      platformButtonsContainer.innerHTML = `<span style="margin: 21px 34px;">Schon bald werden hier Plattformen für dich zur Verfügung stehen.</span>`
                      throw new Error("platform not found")

                    }

                    Helper.convert("parent/scrollable", platformButtonsContainer)

                    Helper.render("platforms/location", platforms, platformButtonsContainer)

                  }


                }


              }

              if (res.status === 200) {

                const get = {}
                get.url = "/get/platforms/closed/"
                const res = await Helper.request("closed/json", get)

                if (res.status !== 200) {

                  Helper.convert("parent/info", platformButtonsContainer)

                  platformButtonsContainer.innerHTML = `<span style="margin: 21px 34px;">Schon bald werden hier Plattformen für dich zur Verfügung stehen.</span>`
                  throw new Error("platform not found")

                }

                if (res.status === 200) {
                  const platforms = JSON.parse(res.response)

                  if (platforms.length === 0) {

                    Helper.convert("parent/info", platformButtonsContainer)

                    platformButtonsContainer.innerHTML = `<span style="margin: 21px 34px;">Schon bald werden hier Plattformen für dich zur Verfügung stehen.</span>`
                    throw new Error("platform not found")

                  }

                  Helper.convert("parent/scrollable", platformButtonsContainer)
                  Helper.render("platforms/closed", platforms, platformButtonsContainer)
                }

              }

            }

          }
        }



      }

    </script>

  </body>
</html>
