<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="shortcut icon" href="/public/getyour-logo.svg" />
    <title>SHS Funnel Abfrage Persönliches</title>


    <style>
      body {
        margin: 0;
        line-height: 1.2;
        font-family: sans-serif;
      }
    </style>


  </head>
  <body>


    <header></header>

    <h1 class="personal-title"></h1>
    <div class="info"></div>

    <div class="firstname"></div>
    <div class="lastname"></div>
    <div class="street"></div>
    <div class="zip"></div>
    <div class="country"></div>
    <div class="state"></div>
    <div class="email"></div>
    <div class="password"></div>
    <div class="confirmPassword"></div>


    <div class="save-and-proceed-button"></div>
    <div class="info-under-button"></div>

    <footer></footer>


    <script type="module">
      import { HeaderField } from "/js/HeaderField.js"
      import { InfoField } from "/js/InfoField.js"
      import { DivField } from "/js/DivField.js"
      import { TextField } from "/js/TextField.js"
      import { PasswordField } from "/js/PasswordField.js"
      import { Helper } from "/js/Helper.js"
      import { SelectionField } from "/js/SelectionField.js"
      import { EmailField } from "/js/EmailField.js"
      import { Request } from "/js/Request.js"


      const funnel = Helper.findFunnel(funnel => funnel.owner.id === Request.localStorageId())
      if (
        funnel === undefined ||
        funnel.value === undefined ||
        funnel.questionIndex < funnel.questions.length - 1
        ) {
        window.location.assign("/felix/shs/funnel/qualifizierung/")
        throw new Error("funnel not found")
      }

      const offer = Helper.findOffer(offer => offer.value.selected === true)
      if (offer === undefined) {
        window.location.assign("/felix/shs/match-maker/hersteller-vergleich/")
        throw new Error("offer not found")
      }

      const headerField = new HeaderField()
      .withImage(img => {
        img.src = "/felix/shs/public/shslogo.png"
        img.alt = "SHS Express Logo"
        img.style.cursor = "pointer"
        img.style.width = "144px"
        img.addEventListener("click", async() => await Helper.redirectUser())
      })
      .withType(header => {
        header.style.position = "fixed"
        header.style.top = "0"
        header.style.left = "0"
        header.style.zIndex = "1"
        header.style.backgroundColor = "white"
        header.style.width = "100%"
      })
      .build()

      document.querySelectorAll(".personal-title").forEach(title => {
        title.innerHTML = "Konto erstellen"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })

      const infoField = new InfoField("info")
      .withSuccess("Konto erstellen, Daten sichern, Angebote bearbeiten und Zugang zu Ihrer persönlichen Checkliste erhalten.")
      .withType(info => info.style.fontSize = "21px")
      .build()


      const firstname = new TextField("firstname")
      .withLabel(label => label.innerHTML = "Vorname")
      .withType(text => {
        text.placeholder = "Max"
        text.required = true
      })
      .onInput(async() => {
        firstname.withStorage(value => {
          funnel.owner[firstname.name] = value
          Helper.setFunnel(funnel)
          offer.owner[firstname.name] = value
          Helper.setOffer(offer)
        })
      })
      .fromStorage((name) => funnel.owner[name])
      firstname.withStorage(value => {
        funnel.owner[firstname.name] = value
        Helper.setFunnel(funnel)
        offer.owner[firstname.name] = value
        Helper.setOffer(offer)
      })


      const lastname = new TextField("lastname")
      .withLabel(label => label.innerHTML = "Nachname")
      .withType(text => {
        text.placeholder = "Muster"
        text.required = true
      })
      .onInput(async() => {
        lastname.withStorage(value => {
          funnel.owner[lastname.name] = value
          Helper.setFunnel(funnel)
          offer.owner[lastname.name] = value
          Helper.setOffer(offer)
        })
      })
      .fromStorage((name) => funnel.owner[name])
      lastname.withStorage(value => {
        funnel.owner[lastname.name] = value
        Helper.setFunnel(funnel)
        offer.owner[lastname.name] = value
        Helper.setOffer(offer)
      })


      const street = new TextField("street")
      .withLabel(label => label.innerHTML = "Straße und Hausnummer")
      .withType(text => {
        text.placeholder = "Wiesentalstr. 43"
        text.required = true
      })
      .onInput(async() => {
        street.withStorage(value => {
          funnel.owner[street.name] = value
          Helper.setFunnel(funnel)
          offer.owner[street.name] = value
          Helper.setOffer(offer)
        })
      })
      .fromStorage((name) => funnel.owner[name])
      street.withStorage(value => {
        funnel.owner[street.name] = value
        Helper.setFunnel(funnel)
        offer.owner[street.name] = value
        Helper.setOffer(offer)
      })



      const zip = new TextField("zip")
      .withLabel(label => label.innerHTML = "Postleitzahl und Stadt")
      .withType(text => {
        text.placeholder = "70190 Stuttgart"
        text.required = true
        text.pattern = "[1-9][0-9]{4}\\s.[^\\s]+"
      })
      .onInput(async() => {
        zip.withStorage(value => {
          funnel.owner[zip.name] = value
          Helper.setFunnel(funnel)
          offer.owner[zip.name] = value
          Helper.setOffer(offer)
        })
      })
      .fromStorage((name) => funnel.owner[name])
      zip.withStorage(value => {
        funnel.owner[zip.name] = value
        Helper.setFunnel(funnel)
        offer.owner[zip.name] = value
        Helper.setOffer(offer)
      })



      const state = new SelectionField("state")
      .withLabel(label => label.innerHTML = "Bundesland oder Kanton")
      .withOptions(["Baden-Württemberg", "Bayern", "Berlin", "Brandenburg", "Bremen", "Hamburg", "Hessen", "Mecklenburg-Vorpommern", "Niedersachsen", "Nordrhein Westfalen", "Rheinland-Pfalz", "Saarland", "Sachsen", "Sachsen-Anhalt", "Schleswig-Holstein", "Thüringen", "Burgenland", "Kärnten", "Niederösterreich", "Oberösterreich", "Salzburg", "Steiermark", "Tirol", "Vorarlberg", "Wien", "Aargau", "Appenzell Ausserrhoden", "Appenzell Innerrhoden", "Basel-Land", "Basel-Stadt", "Bern", "Fribourg Freiburg", "Genève Geneva", "Glarus", "Graubünden Grischuns Grigioni", "Jura", "Luzern Lucerne", "Neuchâtel", "Nidwalden", "Obwalden", "St.Gallen", "Schaffhausen", "Schwyz", "Solothurn", "Thurgau", "Ticino", "Uri", "Vaud", "Valais Wallis", "Zug", "Zürich"])
      .onInput(async() => {
        state.withStorage(options => {
          funnel.owner[state.name] = options[0]
          Helper.setFunnel(funnel)
          offer.owner[state.name] = options[0]
          Helper.setOffer(offer)
        })
      })
      .fromStorage((name) => funnel.owner[name])
      state.withStorage(options => {
        funnel.owner[state.name] = options[0]
        Helper.setFunnel(funnel)
        offer.owner[state.name] = options[0]
        Helper.setOffer(offer)
      })


      const country = new SelectionField("country")
      .withLabel(label => label.innerHTML = "Land")
      .withOptions(["Deutschland", "Österreich", "Schweiz"])
      .onWindowLoad(async event => await changeState())
      .onChange(async event => await changeState())
      .onInput(async() => {
        country.withStorage(options => {
          funnel.owner[country.name] = options[0]
          Helper.setFunnel(funnel)
          offer.owner[country.name] = options[0]
          Helper.setOffer(offer)
        })
      })
      .fromStorage((name) => funnel.owner[name])
      country.withStorage(options => {
        funnel.owner[country.name] = options[0]
        Helper.setFunnel(funnel)
        offer.owner[country.name] = options[0]
        Helper.setOffer(offer)
      })


      const emailField = new EmailField("email")
      .withLabel(label => label.innerHTML = "E-Mail Adresse")
      .withType(email => {
        email.placeholder = "max.mustermann@web.de"
        email.required = true
      })
      .onInput(async() => {
        emailField.withStorage(value => {
          window.localStorage.setItem(emailField.name, value)
        })
      })
      .fromStorage((name) => window.localStorage.getItem(name))
      emailField.withStorage(value => {
        window.localStorage.setItem(emailField.name, value)
      })


      const passwordField = new PasswordField("password")
      .withLabel(label => label.innerHTML = "Passwort")
      .withType(password => {
        password.placeholder = "Passwort.."
        password.required = true
      })
      .onInput(() => passwordField.withValidValue())
      passwordField.withValidValue()


      const confirmPasswordField = new PasswordField("confirmPassword")
      .withLabel(label => label.innerHTML = "Posswort bestätigen")
      .withType(password => {
        password.placeholder = "Passwort bestätigen.."
        password.required = true
      })
      .onInput(() => confirmPasswordField.withValidValue())
      confirmPasswordField.withValidValue()


      const speichernundweiterbutton = new DivField("save-and-proceed-button")
      .withType(div => {
        div.innerHTML = "Jetzt zur Übersicht"
        div.style.fontSize = "21px"
        div.style.margin = "144px 34px 0 34px"
        div.style.backgroundColor = "#f7aa20"
        div.style.borderRadius = "13px"
        div.style.height = "89px"
        div.style.display = "flex"
        div.style.justifyContent = "center"
        div.style.alignItems = "center"
        div.addEventListener("mouseover", () => div.style.backgroundColor = "#f19d08")
        div.addEventListener("mouseout", () => div.style.backgroundColor = "#f7aa20")
      })
      .onClick(async () => await checkAndProceed())

      const infoUnderButtonField = new InfoField("info-under-button")
      .withSuccess("*unverbindliches und kostenloses Angebot erhalten")
      .build()

      Helper.createSHSFooter()


      const fields = [
        firstname,
        lastname,
        street,
        zip,
        country,
        state,
        emailField,
        passwordField,
        confirmPasswordField,
      ]



      async function checkAndProceed() {
        for (let i = 0; i < fields.length; i++) {
          await fields[i].withValidValue()
        }

        const email = await emailField.withValidValue()
        const password = await passwordField.withValidValue()
        const confirmPassword = await confirmPasswordField.withValidValue()
        const passwordHash = await Helper.digest(password)
        const confirmPasswordHash = await Helper.digest(confirmPassword)

        if (passwordHash !== confirmPasswordHash) {
          confirmPasswordField.withType(input => Helper.setNotValidStyle(input))
        } else {

          const funnel = Helper.findFunnel(funnel => funnel.owner.id === Request.localStorageId())
          const offer = Helper.findOffer(offer => offer.value.selected === true)

          await Request.verifyEmail(email)


          const localStorageId = Request.localStorageId()

          const registerEmail = {}
          registerEmail.url = "/consumer/v1/"
          registerEmail.method = "register"
          registerEmail.type = "email"
          registerEmail.security = "open"
          registerEmail.email = email
          registerEmail.localStorageId = localStorageId
          await Request.sequence(registerEmail)

          const registerVerified = {}
          registerVerified.url = "/consumer/v1/"
          registerVerified.method = "register"
          registerVerified.type = "verified"
          registerVerified.security = "open"
          registerVerified.localStorageId = localStorageId
          await Request.sequence(registerVerified)

          const registerOperator = {}
          registerOperator.url = "/consumer/v1/"
          registerOperator.method = "register"
          registerOperator.type = "role"
          registerOperator.name = "operator"
          registerOperator.security = "open"
          registerOperator.localStorageId = localStorageId
          await Request.sequence(registerOperator)

          const registerSession = {}
          registerSession.url = "/request/register/session/"
          registerSession.method = "register"
          registerSession.type = "session"
          registerSession.security = "open"
          registerSession.localStorageId = localStorageId
          await Request.sequence(registerSession)

          const registerFunnel = {}
          registerFunnel.url = "/consumer/v1/"
          registerFunnel.method = "register"
          registerFunnel.type = "funnel"
          registerFunnel.security = "closed"
          registerFunnel.localStorageId = localStorageId
          registerFunnel.funnel = funnel
          await Request.sequence(registerFunnel)

          const registerOffer = {}
          registerOffer.url = "/consumer/v1/"
          registerOffer.method = "register"
          registerOffer.type = "offer"
          registerOffer.security = "closed"
          registerOffer.localStorageId = localStorageId
          registerOffer.offer = offer
          await Request.sequence(registerOffer)

          const registerChecklist = {}
          registerChecklist.url = "/consumer/v1/"
          registerChecklist.method = "register"
          registerChecklist.type = "checklist"
          registerChecklist.security = "closed"
          registerChecklist.localStorageId = localStorageId
          await Request.sequence(registerChecklist)

          alert("Speichern erfolgreich..")
          window.location.assign(`/felix/shs/checklist/${localStorageId}/`)
        }
      }




      async function changeState() {
        const options = await country.withValidValue()
        if (options[0].value === "Deutschland") {
          state.withOptions(["Baden-Württemberg", "Bayern", "Berlin", "Brandenburg", "Bremen", "Hamburg", "Hessen", "Mecklenburg-Vorpommern", "Niedersachsen", "Nordrhein Westfalen", "Rheinland-Pfalz", "Saarland", "Sachsen", "Sachsen-Anhalt", "Schleswig-Holstein", "Thüringen"])
        }
        if (options[0].value === "Österreich") {
          state.withOptions(["Burgenland", "Kärnten", "Niederösterreich", "Oberösterreich", "Salzburg", "Steiermark", "Tirol", "Vorarlberg", "Wien"])
        }
        if (options[0].value === "Schweiz") {
          state.withOptions(["Aargau", "Appenzell Ausserrhoden", "Appenzell Innerrhoden", "Basel-Land", "Basel-Stadt", "Bern", "Fribourg Freiburg", "Genève Geneva", "Glarus", "Graubünden Grischuns Grigioni", "Jura", "Luzern Lucerne", "Neuchâtel", "Nidwalden", "Obwalden", "St.Gallen", "Schaffhausen", "Schwyz", "Solothurn", "Thurgau", "Ticino", "Uri", "Vaud", "Valais Wallis", "Zug", "Zürich"])
        }
        state.withStorage(options => {
          funnel.owner[state.name] = options[0]
          Helper.setFunnel(funnel)
        })
      }


    </script>

  </body>
</html>
