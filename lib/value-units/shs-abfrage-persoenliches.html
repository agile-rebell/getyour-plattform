<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <title>SHS Funnel</title>


    <style>
      body {
        margin: 0;
        line-height: 1.2;
        font-family: sans-serif;
      }
    </style>


  </head>
  <body>


    <header></header>

    <h1 class="personal-title"></h1>
    <div class="info"></div>
    <div class="personal-funnel"></div>

    <div class="save-and-proceed-button"></div>
    <div class="info-under-button"></div>

    <footer></footer>


    <script type="module">
      import { HeaderField } from "../../../../js/HeaderField.js"
      import { InfoField } from "../../../../js/InfoField.js"
      import { FunnelField } from "../../../../js/FunnelField.js"
      import { CheckboxField } from "../../../../js/CheckboxField.js"
      import { DivField } from "../../../../js/DivField.js"
      import { FileField } from "../../../../js/FileField.js"
      import { Helper } from "../../../../js/Helper.js"
      import { NumberField } from "../../../../js/NumberField.js"
      import { SelectionField } from "../../../../js/SelectionField.js"
      import { Request } from "../../../../js/Request.js"


      /// replace this with database request in new version
      const funnel = Helper.getFunnelByStorageName("shsFunnel")
      // if (funnel === undefined) {
      //   window.location.assign("/felix/shs/funnel/qualifizierung/")
      //   throw new Error("funnel not found")
      // }
      // console.log(funnel);

      const offer = Helper.getSelectedOffer()
      // if (offer === undefined) {
      //   window.location.assign("/felix/shs/match-maker/hersteller-vergleich/")
      //   throw new Error("offer not found")
      // }
      // console.log(offer);


      const headerField = new HeaderField()
      .withImage(img => {
        img.src = "../../public/shslogo.png"
        img.alt = "SHS Express Logo"
        img.style.cursor = "pointer"
        img.style.width = "144px"
        img.addEventListener("click", async() => await Helper.redirectOperatorToChecklist())
      })
      .withType(header => {
        header.style.position = "fixed"
        header.style.top = "0"
        header.style.left = "0"
        header.style.zIndex = "1"
        header.style.backgroundColor = "white"
      })
      .build()

      // .withNavigation([
      //   {active: true, name: "Haus", onclick: async() => await checkAndProceed(funnel.path.house)},
      //   {active: true, name: "Heizung", onclick: async() => await checkAndProceed(funnel.path.heating)},
      //   {active: true, name: "Strom", onclick: async() => await checkAndProceed(funnel.path.electricity)},
      //   {active: true, name: "Technisches", onclick: async() => await checkAndProceed(funnel.path.technical)}
      // ])

      document.querySelectorAll(".personal-title").forEach(title => {
        title.innerHTML = "Konto erstellen"
        title.style.margin = "144px 34px 34px 34px"
        title.style.fontWeight = "normal"
      })

      const infoField = new InfoField("info")
      .withSuccess("Konto erstellen, Daten sichern, Angebote bearbeiten und Zugang zu Ihrer persönlichen Checkliste erhalten.")
      .withType(info => info.style.fontSize = "21px")
      .build()

      const personalFunnel = new FunnelField("personal-funnel")
      .withFields([
        {class: "firstname", type: "text", withLabel: "Vorname", withType: firstnameOption},
        {class: "lastname", type: "text", withLabel: "Nachname", withType: lastnameOption},
        {class: "street", type: "text", withLabel: "Straße und Hausnummer", withType: streetOption},
        {class: "zip", type: "text", withLabel: "Postleitzahl", withType: zipOption},
        {class: "state", type: "text", withLabel: "Bundesland", withType: stateOption},
        {class: "country", type: "text", withLabel: "Land", withType: countryOption},
        {class: "email", type: "email", withLabel: "E-Mail Adresse", withType: emailOption},
        {class: "password", type: "password", withLabel: "Passwort", withType: passwordOption},
        {class: "confirmPassword", type: "password", withLabel: "Posswort bestätigen", withType: confirmPasswordOption},
      ])

      function confirmPasswordOption(input) {
        input.placeholder = "Passwort bestätigen.."
        input.required = true
        // input.minlength = 6
      }

      function passwordOption(input) {
        input.placeholder = "Passwort.."
        // input.minlength = 6
        input.required = true
      }

      function emailOption(input) {
        input.placeholder = "max.mustermann@web.de"
        input.required = true
        // input.fromStorage("email")
      }

      function countryOption(input) {
        input.placeholder = "Deutschland"
        input.required = true
      }

      function stateOption(input) {
        input.placeholder = "Baden-Württemberg"
        input.required = true
      }

      function zipOption(input) {
        input.placeholder = "70190 Stuttgart"
        input.required = true
        input.pattern = "[1-9][0-9]{4}\\s.[^\\s]+"
      }

      function streetOption(input) {
        input.placeholder = "Hauptstr. 21"
        input.required = true
      }

      function lastnameOption(input) {
        input.placeholder = "Muster"
        input.required = true
      }

      function firstnameOption(input) {
        input.placeholder = "Max"
        input.required = true
      }


      // refactor this
      personalFunnel.withStorage(funnel.storage).buildFields()
      // console.log(personalFunnel.firstname);
      // personalFunnel.firstname.withType(text => {
      //   // console.log();
      //   text.value = "Was geht"
      // })


      const speichernundweiterbutton = new DivField("save-and-proceed-button")
      .withType(div => {
        div.innerHTML = "Jetzt zur Übersicht"
        div.style.fontSize = "21px"
        div.style.margin = "144px 34px 0 34px"
        div.style.backgroundColor = "#f7aa20"
        div.style.borderRadius = "13px"
        div.style.height = "89px"
        div.style.display = "flex"
        div.style.justifyContent = "center"
        div.style.alignItems = "center"
        div.addEventListener("mouseover", () => div.style.backgroundColor = "#f19d08")
        div.addEventListener("mouseout", () => div.style.backgroundColor = "#f7aa20")
      })
      .onClick(async () => await checkAndProceed())

      const infoUnderButtonField = new InfoField("info-under-button")
      .withSuccess("*unverbindliches und kostenloses Angebot erhalten")
      .build()

      Helper.createSHSFooter()

      async function checkAndProceed() {
        await personalFunnel.checkValidity()

        // console.log(personalFunnel.firstname);


        const email = await personalFunnel.email.withValidValue()
        const password = await personalFunnel.password.withValidValue()
        const confirmPassword = await personalFunnel.confirmPassword.withValidValue()
        const passwordHash = await Helper.digest(password)
        const confirmPasswordHash = await Helper.digest(confirmPassword)

        if (passwordHash !== confirmPasswordHash) {
          personalFunnel.confirmPassword.withType(input => Helper.setNotValidStyle(input))
        } else {
          Helper.addOverlay()
          Helper.setWaitCursor()



          // console.log(funnelStorage);
          // console.log(offerStorage);



          try {
            const funnelStorage = Helper.getFunnelByStorageName(funnel.storage)
            const offerStorage = Helper.getSelectedOffer()
            await Request.withVerifiedEmail(email, async() => {
              const localStorageId = Request.localStorageId()

              const registerEmail = {}
              registerEmail.url = "/consumer/v1/"
              registerEmail.consumer = "operator"
              registerEmail.method = "register"
              registerEmail.type = "email"
              registerEmail.security = "open"
              // registerEmail.name = "onregister"
              registerEmail.email = email
              registerEmail.localStorageId = localStorageId
              await Request.sequence(registerEmail)

              const verifyUser = {}
              verifyUser.url = "/consumer/v1/"
              verifyUser.consumer = "operator"
              verifyUser.method = "verify"
              verifyUser.type = "email"
              verifyUser.security = "open"
              verifyUser.name = "onregister"
              verifyUser.localStorageId = localStorageId
              await Request.sequence(verifyUser)

              const registerOperator = {}
              registerOperator.url = "/consumer/v1/"
              registerOperator.consumer = "operator"
              registerOperator.method = "register"
              registerOperator.type = "role"
              registerOperator.security = "open"
              registerOperator.name = "onregister"
              registerOperator.localStorageId = localStorageId
              await Request.sequence(registerOperator)

              const registerSession = {}
              registerSession.url = "/request/register/session/"
              registerSession.consumer = "operator"
              registerSession.method = "register"
              registerSession.type = "session"
              registerSession.security = "open"
              registerSession.name = "onregister"
              registerSession.localStorageId = localStorageId
              await Request.sequence(registerSession)

              const registerFunnel = {}
              registerFunnel.url = "/consumer/v1/"
              registerFunnel.consumer = "operator"
              registerFunnel.method = "register"
              registerFunnel.type = "funnel"
              registerFunnel.security = "closed"
              // registerFunnel.name = "onregister"
              registerFunnel.localStorageId = localStorageId
              registerFunnel.funnel = funnelStorage
              await Request.sequence(registerFunnel)

              const registerOffer = {}
              registerOffer.url = "/consumer/v1/"
              registerOffer.consumer = "operator"
              registerOffer.method = "register"
              registerOffer.type = "offer"
              registerOffer.security = "closed"
              // registerOffer.name = "onregister"
              registerOffer.localStorageId = localStorageId
              registerOffer.offer = offerStorage
              registerOffer.funnel = funnelStorage
              await Request.sequence(registerOffer)

              const registerChecklist = {}
              registerChecklist.url = "/consumer/v1/"
              registerChecklist.consumer = "operator"
              registerChecklist.method = "register"
              registerChecklist.type = "checklist"
              registerChecklist.security = "closed"
              // registerChecklist.name = "onregister"
              registerChecklist.localStorageId = localStorageId
              await Request.sequence(registerChecklist)

              window.localStorage.setItem("email", email)


              alert("Speichern erfolgreich..")
              window.location.assign(`/felix/shs/checklist/${localStorageId}/`)
              Helper.removeOverlay()
            })

          } catch (error) {
            console.error(error)
          }
          Helper.setNotAllowedCursor()
        }
      }


    </script>

  </body>
</html>
