<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link rel="shortcut icon" href="/public/getyour-logo.svg" />
    <title>SHS Anlagenbetreiber Qualifizierung</title>

  </head>
  <body style="margin: 0; background: #ebebeb; font-family: sans-serif; background-image: url('/felix/shs/public/qualifizierung-bg.png'); background-repeat: no-repeat; background-size: cover;">

    <header></header>

    <div class="info"></div>

    <div class="funnel-placeholder"></div>

    <footer></footer>

    <script type="module">
      import { HeaderField } from "/js/HeaderField.js"
      import { InfoField } from "/js/InfoField.js"
      import { FunnelField } from "/js/FunnelField.js"
      import { Helper } from "/js/Helper.js"
      import { Request } from "/js/Request.js"
      import { DivField } from "/js/DivField.js"

      const getFunnel = {}
      getFunnel.url = "/consumer/v1/"
      getFunnel.method = "get"
      getFunnel.name = "shs"
      getFunnel.type = "funnel"
      getFunnel.security = "open"
      getFunnel.localStorageId = Request.localStorageId()
      const res = await Request.middleware(getFunnel)

      if (res.status !== 200) {
        window.location.assign("/home/")
        throw new Error("get funnel failed")
      }

      const shsFunnel = Helper.findFunnel(funnel => funnel.owner.id === Request.localStorageId())
      if (shsFunnel !== undefined) {
        if (shsFunnel.value !== undefined) {
          if (shsFunnel.questionIndex >= shsFunnel.questions.length - 1) {
            window.location.assign(shsFunnel.path.house)
            throw new Error("funnel exist")
          }
        }
      }

      const funnel = JSON.parse(res.response)
      Helper.setFunnel(funnel)

      const headerField = new HeaderField()
      .withImage(img => {
        img.src = "/felix/shs/public/shslogo.png"
        img.alt = "SHS Express Logo"
        img.style.cursor = "pointer"
        img.style.width = "144px"
        img.addEventListener("click", async() => window.location.reload())
      })
      .withType(header => {
        header.style.position = "fixed"
        header.style.top = "0"
        header.style.left = "0"
        header.style.backgroundColor = "white"
        header.style.width = "100%"
      })
      .build()

      const infoField = new InfoField("info")
      .withSuccess(/*html*/`
        <div style="font-size: 21px; margin-bottom: 55px"> Jetzt <span style="color: #f27f2a;">Unabhängig</span> von öffentlichen Energieversorgern werden!</div>
        <div style="margin-bottom: 21px">Erstellen Sie sich einfach ihr maßgeschneidertes Energiekonzept.</div>
        <div>Kostenlos & unverbindlich.</div>
      `)
      .build()
      .withType(info => {
        info.style.margin = "144px 34px 34px 34px"
      })


      const funnelField = new FunnelField("funnel-placeholder")
      .withFunnel(funnel)
      .onWindowUnload(() => {
        if (shsFunnel.questionIndex <= (shsFunnel.questions.length - 1)) {
          const funnels = JSON.parse(window.localStorage.getItem("funnels"))
          if (funnels !== null) {
            const newFunnels = funnels.filter(it => it.storage !== this.funnel.storage)
            window.localStorage.setItem("funnels", JSON.stringify(newFunnels))
          }
        }
      })
      .withClickOnAnswerEventListener((questionIndex, answerIndex) => {

        if (questionIndex === 0 && answerIndex === 1) {
          // const confirm = window.confirm("Möchten Sie stattdessen einen persönlichen Ansprechpartner kontaktieren?")
          // if (confirm === true) return window.location.assign("/felix/shs/match-maker/experte-kontaktieren/")
          window.location.assign("/felix/shs/")
          return
        }

        if (questionIndex === 1 && answerIndex === 1) {
          // const confirm = window.confirm("Im Moment bieten wir diese Option nicht an. Möchten Sie stattdessen einen persönlichen Ansprechpartner kontaktieren?")
          // if (confirm === true) return window.location.assign("/felix/shs/match-maker/experte-kontaktieren/")
          window.location.assign("/felix/shs/")
          return
        }

        if (questionIndex === 1 && answerIndex === 3) {
          window.location.assign("/felix/shs/")
          return
        }

        if (questionIndex === 10 && answerIndex === 1) {
          const shsFunnel = Helper.getFunnel(funnel.storage)
          const q7 = shsFunnel.value.q7
          const q8 = shsFunnel.value.q8
          const q9 = shsFunnel.value.q9
          if (q7 === 1 && q8 === 1 && q9 === 1) {
            window.location.assign("/felix/shs/")
            return
          }
        }

        if (questionIndex === 11 && answerIndex === 1) {
          window.location.assign("/felix/shs/")
          return
        }

        funnel.questionIndex = funnel.questionIndex + 1
        funnelField.withFunnel(funnel)
      })
      .withFunnelCompleted(async() => {
        window.location.assign(funnel.path.house)
      })

      Helper.createSHSFooter()

    </script>

  </body>
</html>
