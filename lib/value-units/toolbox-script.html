<script id="toolbox" type="module">

  import {Request} from "/js/Request.js"
  import {Helper} from "/js/Helper.js"
  import {FileField} from "/js/FileField.js"
  import {TextField} from "/js/TextField.js"
  import {SelectionField} from "/js/SelectionField.js"
  import {TextAreaField} from "/js/TextAreaField.js"
  import {RangeField} from "/js/RangeField.js"

  // refactor toolbox

  const localStoragId = window.localStorage.getItem("localStorageId")
  if (localStoragId !== null) {
    const localStorageEmail = window.localStorage.getItem("email")
    if (localStorageEmail !== null) {

      {
        const verify = {}
        verify.url = "/verify/expert/closed/"
        const res = await Request.closed(verify)

        if (res.status === 200) {

          {
            const back = Helper.headerPicker("back")
            const toolbox = Helper.headerPicker("app")

            back.setAttribute("data-id", "toolbox")
            toolbox.setAttribute("data-id", "toolbox")

            document.body.insertBefore(back, document.querySelector("#toolbox"))
            document.body.insertBefore(toolbox, document.querySelector("#toolbox"))

            toolbox.addEventListener("click", () => {

              Helper.popup(async overlay => {

                Helper.headerPicker("removeOverlay", overlay)

                Helper.buttonPicker("toolbox/register-html", overlay)

                const buttons = Helper.headerPicker("scrollable", overlay)

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "document.children"
                  button.right.innerHTML = "Dokumenten Inhalt"
                  button.addEventListener("click", () => {
                    Helper.popup(overlay => {
                      Helper.headerPicker("removeOverlay", overlay)
                      const info = Helper.headerPicker("info", overlay)
                      info.innerHTML = "document.children"

                      Helper.buttonPicker("toolbox/register-html", overlay)


                      const childrenContainer = Helper.headerPicker("scrollable", overlay)
                      Helper.render("children", document.documentElement, childrenContainer)


                    })
                  })
                }

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "document.write"
                  button.right.innerHTML = "Aktuelles Dokument ersetzen"

                  button.addEventListener("click", () => {

                    Helper.popup(overlay => {

                      Helper.headerPicker("removeOverlay", overlay)

                      const funnel = Helper.headerPicker("scrollable", overlay)

                      const htmlField = new TextAreaField("html", funnel)
                      htmlField.label.innerHTML = "HTML Import"
                      htmlField.input.style.fontFamily = "monospace"
                      htmlField.input.style.fontSize = "13px"
                      htmlField.input.style.height = "89px"
                      htmlField.input.placeholder = `<html>..</html>`
                      htmlField.input.addEventListener("input", () => htmlField.verifyValue())
                      htmlField.verifyValue()

                      const button = Helper.buttonPicker("action", funnel)
                      button.innerHTML = "Dokument jetzt ersetzen"
                      button.addEventListener("click", async () => {

                        const html = htmlField.validValue()

                        const confirm = window.confirm("Achtung! Diese Funktion wird dein aktuelles HTML Dokument mit deinem neuen HTML Import ersetzen. Der Inhalt deines aktuellen Dokuments wird unwideruflich gelöscht, sobald du deine Werteinheit abspeicherst.\n\n Möchtest du dein aktuelles HTML Dokument wirklich ersetzen?")
                        if (confirm === true) {

                          document.open()
                          document.write(html)
                          document.close()

                          Helper.create("script/toolbox-getter", document.body)

                          Helper.removeOverlay(overlay)
                        }


                      })

                    })


                  })

                }

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "template.import"
                  button.right.innerHTML = "HTML Script importieren"
                  button.addEventListener("click", () => {

                    Helper.popup(overlay => {

                      Helper.headerPicker("removeOverlay", overlay)

                      const funnel = Helper.headerPicker("scrollable", overlay)

                      const htmlField = new TextAreaField("script-import", funnel)
                      htmlField.label.innerHTML = "HTML Skript"
                      htmlField.input.required = true
                      htmlField.input.style.fontFamily = "monospace"
                      htmlField.input.style.fontSize = "13px"
                      htmlField.input.style.height = "89px"
                      htmlField.input.placeholder = `<script id=".." alias=".." >..</>`
                      htmlField.input.addEventListener("input", () => htmlField.verifyValue())
                      htmlField.verifyValue()

                      const button = Helper.buttonPicker("action", funnel)
                      button.innerHTML = "Template jetzt importieren"
                      button.addEventListener("click", async () => {

                        const html = htmlField.validValue()

                        const parser = document.createElement("div")
                        parser.innerHTML = html

                        if (parser.children.length > 1) {
                          alert("Es kann nur ein HTML Script Element auf einmal gespeichert werden.")
                          Helper.setNotValidStyle(htmlField.input)
                          throw new Error(`too many children`)
                        }

                        const node = parser.firstChild

                        if (node.tagName !== "SCRIPT") {
                          alert("Es können nur HTML Script Elemente als Templates gespeichert werden. Der von dir bereitgestellte Code ist kein HTML Script Element.")
                          Helper.setNotValidStyle(htmlField.input)
                          throw new Error(`not a script`)
                        }

                        if (Helper.stringIsEmpty(node.id)) {
                          alert("HTML Script Element benötigt eine Id.")
                          Helper.setNotValidStyle(htmlField.input)
                          throw new Error(`id is empty`)
                        }

                        if (!Helper.verifyIs("text/tag", node.id)) {
                          alert("Id muss vom 'tag' Format sein. Es sind nur Kleinbuchstaben (a-z) und Bindestriche dazwischen erlaubt. (-)")
                          Helper.setNotValidStyle(htmlField.input)
                          throw new Error(`id is not a tag`)
                        }

                        const verify = {}
                        verify.url = "/verify/template/closed/"
                        verify.type = "id"
                        verify.id = node.id
                        const res = await Request.closed(verify)

                        if (res.status === 200) {
                          alert("Id existiert bereits.")
                          Helper.setNotValidStyle(htmlField.input)
                          throw new Error(`id exist`)
                        }

                        if (Helper.stringIsEmpty(node.getAttribute("alias"))) {
                          alert("HTML Script Element benötigt eine Alias.")
                          Helper.setNotValidStyle(htmlField.input)
                          throw new Error(`alias is empty`)
                        }

                        const script = document.createElement("script")
                        script.innerHTML = node.innerHTML

                        Helper.overlay("security", async securityOverlay => {

                          const register = {}
                          register.url = "/register/template/closed/"
                          register.id = node.id
                          register.alias = node.getAttribute("alias")
                          register.script = script.outerHTML
                          const res = await Request.closed(register)

                          if (res.status === 200) {
                            alert("Template erfolgreich gespeichert.")
                            Helper.removeOverlay(securityOverlay)
                            Helper.removeOverlay(overlay)
                          } else {
                            alert("Fehler.. Bitte wiederholen.")
                            Helper.removeOverlay(securityOverlay)
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`register template failed`)
                          }
                        })

                      })

                    })

                  })
                }

              })

            })


            const observer = new MutationObserver((mutations, observer) => {
              for (let i = 0; i < mutations.length; i++) {
                const mutation = mutations[i]
                if (mutation.type === 'attributes' && mutation.attributeName === 'id') {
                  const ids = document.querySelectorAll(`#${mutation.target.id}`)
                  if (ids[1] !== undefined) {
                    ids[0].style.border = `2px dashed ${Helper.colors.matte.light.error}`
                    ids[1].style.border = `2px dashed ${Helper.colors.matte.light.error}`
                  } else {
                    if (ids[0].style.border === "2px dashed rgb(176, 53, 53)") {
                      ids[0].style.border = null
                    }
                  }
                }
              }
            })
            observer.observe(document.documentElement, {
              childList: true,
              subtree: true,
              attributes: true,
            })

          }

        }

      }

    }
  }

</script>
