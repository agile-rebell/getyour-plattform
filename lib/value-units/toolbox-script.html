<script id="toolbox" type="module">

  import {Request} from "/js/Request.js"
  import {Helper} from "/js/Helper.js"
  import {FileField} from "/js/FileField.js"
  import {TextField} from "/js/TextField.js"
  import {SelectionField} from "/js/SelectionField.js"
  import {TextAreaField} from "/js/TextAreaField.js"
  import {RangeField} from "/js/RangeField.js"


  // für jedes element
  // als template speichern
  // erzeugt aus dem element ein script string
  // convert(element/script)
  // speichert das template in die db

  // template verändern
  // lass das script laden
  // verändern geht erstmal nur mit dem css picker


  const localStoragId = window.localStorage.getItem("localStorageId")
  if (localStoragId !== null) {
    const localStorageEmail = window.localStorage.getItem("email")
    if (localStorageEmail !== null) {

      {
        const verify = {}
        verify.url = "/verify/expert/closed/3/"
        verify.event = "toolbox"
        verify.localStorageId = await Request.localStorageId()
        verify.localStorageEmail = await Request.email()
        verify.location = window.location.href
        verify.referer = document.referrer
        const res = await Request.middleware(verify)

        if (res.status === 200) {

          {
            const toolbox = Helper.iconPicker("getyour")
            toolbox.setAttribute("data-id", "toolbox")
            toolbox.style.position = "fixed"
            toolbox.style.bottom = "0"
            toolbox.style.right = "0"

            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              toolbox.style.boxShadow = "0 3px 5px rgba(255, 255, 255, 0.13)"
              toolbox.style.border = `0.3px solid ${Helper.colors.matte.dark.accent}`
              toolbox.style.backgroundColor = Helper.colors.matte.dark.background
            } else {
              toolbox.style.boxShadow = "0 3px 5px rgba(0, 0, 0, 0.13)"
              toolbox.style.border = `0.3px solid ${Helper.colors.matte.light.accent}`
              toolbox.style.backgroundColor = Helper.colors.matte.light.background
            }

            toolbox.style.width = "34px"
            toolbox.style.height = "34px"
            toolbox.style.borderRadius = "50%"
            toolbox.style.margin = "21px 34px"
            toolbox.style.padding = "21px"
            toolbox.style.zIndex = "1"
            toolbox.style.cursor = "pointer"
            document.body.insertBefore(toolbox, document.querySelector("#toolbox"))

            toolbox.addEventListener("click", () => {

              Helper.popup(async overlay => {
                overlay.classList.add("overlay-1")
                const overlay1 = overlay

                {
                  const show = document.createElement("img")
                  show.src = "/public/show.svg"
                  show.alt = "Vorschau"
                  show.style.position = "absolute"
                  show.style.left = "0"
                  show.style.bottom = "0"
                  show.style.width = "55px"
                  show.style.padding = "13px"
                  show.style.margin = "21px 34px"
                  show.style.border = "0.3px solid black"
                  show.style.borderRadius = "50%"
                  show.style.backgroundColor = "#fff"
                  show.style.boxShadow = "0px 5px 8px rgba(0, 0, 0, 0.21)"
                  show.style.zIndex = "999"
                  show.style.cursor = "pointer"
                  show.addEventListener("click", () => Helper.removeOverlay(overlay))
                  overlay.append(show)

                  const save = document.createElement("img")
                  save.src = "/public/save.svg"
                  save.alt = "Speichern"
                  save.style.position = "absolute"
                  save.style.right = "0"
                  save.style.bottom = "0"
                  save.style.width = "55px"
                  save.style.padding = "13px"
                  save.style.margin = "21px 34px"
                  save.style.border = "0.3px solid black"
                  save.style.backgroundColor = "#fff"
                  save.style.borderRadius = "50%"
                  save.style.boxShadow = "0px 5px 8px rgba(0, 0, 0, 0.21)"
                  save.style.zIndex = "999"
                  save.style.cursor = "pointer"
                  save.addEventListener("click", async () => {

                    const toolboxScript = document.getElementById("toolbox")
                    const dataIds = document.querySelectorAll("[data-id]")
                    try {

                      dataIds.forEach(element => element.remove())
                      toolboxScript.remove()
                      overlay.remove()
                      // document.body.removeAttribute("style")
                      document.body.style.overscrollBehavior = null
                      document.body.style.overflow = null

                      const register = {}
                      register.url = "/register/platform-value/closed/3/"
                      register.type = "html"
                      register.html = document.documentElement.outerHTML.replace(/<html>/, "<!DOCTYPE html><html>")
                      register.localStorageId = await Request.localStorageId()
                      register.localStorageEmail = await Request.email()
                      register.location = window.location.href
                      register.referer = document.referrer
                      await Request.sequence(register)

                      window.location.reload()
                    } catch (error) {
                      for (let i = 0; i < dataIds.length; i++) {
                        const dataId = dataIds[i]
                        document.body.insertBefore(dataId, document.querySelector(`script[id='${dataId.getAttribute("data-id")}']`))
                      }
                      alert("Fehler.. Bitte wiederholen.")
                    }

                  })
                  overlay.append(save)

                }


                const buttons = document.createElement("div")
                buttons.style.overflow = "auto"
                buttons.style.overscrollBehavior = "none"
                buttons.style.paddingBottom = "144px"
                overlay.append(buttons)

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "template.import"
                  button.right.innerHTML = "HTML Script Elemente importieren"
                  button.addEventListener("click", () => {

                    Helper.popup(overlay => {

                      Helper.headerPicker("removeOverlay", overlay)

                      {
                        const funnel = document.createElement("div")
                        funnel.style.overflow = "auto"
                        funnel.style.overscrollBehavior = "none"
                        funnel.style.paddingBottom = "144px"
                        overlay.append(funnel)

                        const htmlField = new TextAreaField("script-import", funnel)
                        htmlField.label.innerHTML = "HTML Script Element"
                        htmlField.label.style.fontFamily = "sans-serif"
                        htmlField.input.required = true
                        htmlField.input.style.fontSize = "13px"
                        htmlField.input.style.height = "89px"
                        htmlField.input.placeholder = `<script id=".." alias=".." >..</>`
                        htmlField.input.addEventListener("input", () => {
                          htmlField.verifyValue()
                        })

                        const button = document.createElement("div")
                        button.innerHTML = "Jetzt als Template speichern"
                        button.style.backgroundColor = "#f7aa20"
                        button.style.cursor = "pointer"
                        button.style.fontSize = "21px"
                        button.style.fontFamily = "sans-serif"
                        button.style.borderRadius = "13px"
                        button.style.margin = "21px 34px"
                        button.style.display = "flex"
                        button.style.justifyContent = "center"
                        button.style.alignItems = "center"
                        button.style.height = "89px"
                        button.style.color = "#000"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.addEventListener("click", async () => {

                          const html = htmlField.validValue()

                          const parser = document.createElement("div")
                          parser.innerHTML = html


                          if (parser.children.length > 1) {
                            alert("Es kann nur ein HTML Script Element auf einmal gespeichert werden.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`too many children`)
                          }



                          const node = parser.firstChild

                          if (node.tagName !== "SCRIPT") {
                            alert("Es können nur HTML Script Elemente als Templates gespeichert werden. Der von dir bereitgestellte Code ist kein HTML Script Element.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`not a script`)
                          }

                          if (Helper.stringIsEmpty(node.id)) {
                            alert("HTML Script Element benötigt eine Id.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`id is empty`)
                          }

                          if (!Helper.verifyIs("text/tag", node.id)) {
                            alert("Id muss vom 'tag' Format sein. Es sind nur Kleinbuchstaben (a-z) und Bindestriche dazwischen erlaubt. (-)")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`id is not a tag`)
                          }

                          const verify = {}
                          verify.url = "/verify/template/closed/3/"
                          verify.type = "id"
                          verify.id = node.id
                          verify.localStorageId = await Request.localStorageId()
                          verify.localStorageEmail = await Request.email()
                          verify.location = window.location.href
                          verify.referer = document.referrer
                          const res = await Request.middleware(verify)

                          if (res.status === 200) {
                            alert("Id existiert bereits.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`id exist`)
                          }

                          if (Helper.stringIsEmpty(node.getAttribute("alias"))) {
                            alert("HTML Script Element benötigt eine Alias.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`alias is empty`)
                          }

                          const script = document.createElement("script")
                          script.innerHTML = node.innerHTML

                          Helper.popup(async securityOverlay => {
                            Helper.headerPicker("loading", securityOverlay)
                            const register = {}
                            register.url = "/register/template/closed/3/"
                            register.id = node.id
                            register.alias = node.getAttribute("alias")
                            register.script = script.outerHTML
                            register.localStorageId = await Request.localStorageId()
                            register.localStorageEmail = await Request.email()
                            register.location = window.location.href
                            register.referer = document.referrer
                            const res = await Request.middleware(register)

                            if (res.status === 200) {
                              alert("Template erfolgreich gespeichert.")
                              Helper.removeOverlay(securityOverlay)
                              Helper.removeOverlay(overlay)
                            } else {
                              alert("Fehler.. Bitte wiederholen.")
                              Helper.removeOverlay(securityOverlay)
                              Helper.setNotValidStyle(htmlField.input)
                              throw new Error(`register template failed`)
                            }
                          })

                        })
                        funnel.append(button)
                      }

                    })

                  })
                }

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "document.write"
                  button.right.innerHTML = "Dokument ersetzen"

                  button.addEventListener("click", () => {

                    Helper.popup(overlay => {

                      Helper.headerPicker("removeOverlay", overlay)

                      {
                        const funnel = document.createElement("div")
                        funnel.style.overflow = "auto"
                        funnel.style.overscrollBehavior = "none"
                        funnel.style.paddingBottom = "144px"
                        overlay.append(funnel)

                        const htmlField = new TextAreaField("htm-l", funnel)
                        htmlField.label.innerHTML = "HTML Dokument"
                        htmlField.label.style.fontFamily = "sans-serif"
                        htmlField.input.style.fontSize = "13px"
                        htmlField.input.style.height = "89px"
                        htmlField.input.placeholder = `<html>..</html>`
                        htmlField.input.addEventListener("input", () => {
                          htmlField.verifyValue()
                        })

                        const button = document.createElement("div")
                        button.innerHTML = "Jetzt ersetzen"
                        button.style.backgroundColor = "#f7aa20"
                        button.style.cursor = "pointer"
                        button.style.fontSize = "21px"
                        button.style.fontFamily = "sans-serif"
                        button.style.borderRadius = "13px"
                        button.style.margin = "21px 34px"
                        button.style.display = "flex"
                        button.style.justifyContent = "center"
                        button.style.alignItems = "center"
                        button.style.height = "89px"
                        button.style.color = "#000"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.addEventListener("click", async () => {

                          const html = htmlField.validValue()

                          const confirm = window.confirm("Achtung! Diese Funktion wird dein aktuelles HTML Dokument mit deinem neuen HTML Import ersetzen. Der Inhalt deines aktuellen Dokuments wird unwideruflich gelöscht, sobald du deine Werteinheit abspeicherst.\n\n Möchtest du dein aktuelles HTML Dokument wirklich ersetzen?")
                          if (confirm === true) {

                            const toolbox = document.getElementById("toolbox").cloneNode(true)

                            document.open()
                            document.write(html)
                            document.close()

                            const script = document.createElement("script")
                            script.id = toolbox.id
                            script.type = toolbox.type
                            script.innerHTML = toolbox.innerHTML
                            document.body.append(script)

                          }

                          Helper.removeOverlay(overlay)

                        })
                        funnel.append(button)
                      }



                    })


                  })

                }



                {
                  const button = document.createElement("div")
                  button.style.display = "flex"
                  button.style.flexWrap = "wrap"
                  button.style.justifyContent = "space-between"
                  button.style.alignItems = "center"
                  button.style.margin = "21px 34px"
                  button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"
                  button.style.borderRadius = "13px"
                  button.style.border = "0.3px solid black"
                  button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                  button.style.cursor = "pointer"

                  button.addEventListener("click", async () => {

                    Helper.popup(async overlay => {

                      Helper.headerPicker("removeOverlay", overlay)
                      const elementInfo = Helper.headerPicker("elementInfo", overlay)
                      elementInfo.append(Helper.convert("element/alias", document.head))

                      const headButtons = document.createElement("div")
                      headButtons.style.overflowY = "auto"
                      headButtons.style.paddingBottom = "144px"
                      headButtons.style.overscrollBehavior = "none"
                      overlay.append(headButtons)

                      {
                        const button = document.createElement("div")
                        button.style.display = "flex"
                        button.style.flexWrap = "wrap"
                        button.style.justifyContent = "space-between"
                        button.style.alignItems = "center"
                        button.style.margin = "21px 34px"
                        button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"

                        button.style.borderRadius = "13px"
                        button.style.border = "0.3px solid black"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.style.cursor = "pointer"



                        button.addEventListener("click", async () => {

                          if (document.head.children.length > 0) {

                            Helper.popup(overlay => {


                              Helper.headerPicker("removeOverlay", overlay)
                              const elementInfo = Helper.headerPicker("elementInfo", overlay)

                              elementInfo.append(Helper.convert("element/alias", document.head))

                              const span = document.createElement("span")
                              span.innerHTML = ".children"
                              span.style.fontSize = "13px"
                              span.style.fontFamily = "monospace"
                              elementInfo.append(span)

                              Helper.renderChildren(document.head, overlay)

                            })

                          } else alert("Das HTML Element ist leer.")

                        })

                        const left = document.createElement("div")
                        left.innerHTML = ".children"
                        left.style.margin = "21px 34px"
                        left.style.fontSize = "21px"
                        left.style.fontFamily = "sans-serif"
                        button.append(left)

                        const title = document.createElement("div")
                        title.innerHTML = "Element Inhalt"
                        title.style.margin = "21px 34px"
                        title.style.fontSize = "13px"
                        title.style.fontFamily = "sans-serif"
                        button.append(title)

                        headButtons.append(button)
                      }

                      {

                        const button = Helper.buttonPicker("left/right", headButtons)
                        button.left.innerHTML = ".append"
                        button.right.innerHTML = "Element anhängen"
                        button.addEventListener("click", () => {

                          Helper.popup(overlay => {
                            const overlay3 = overlay

                            Helper.headerPicker("removeOverlay", overlay)

                            const elementInfo = Helper.headerPicker("elementInfo", overlay)
                            elementInfo.append(Helper.convert("element/alias", document.body))

                            const span = document.createElement("span")
                            span.textContent = ".append"
                            span.style.fontSize = "13px"
                            span.style.fontFamily = "monospace"

                            elementInfo.append(span)

                            {
                              const funnel = document.createElement("div")
                              funnel.style.overflowY = "auto"
                              funnel.style.overscrollBehavior = "none"
                              funnel.style.paddingBottom = "144px"
                              overlay.append(funnel)

                              const htmlField = new TextAreaField("html-input", funnel)
                              htmlField.label.innerHTML = "HTML Element"
                              htmlField.label.style.fontFamily = "sans-serif"
                              htmlField.input.style.fontSize = "13px"
                              htmlField.input.style.height = "89px"
                              htmlField.input.placeholder = `<meta .. />`
                              htmlField.input.addEventListener("input", () => {
                                htmlField.verifyValue()
                              })

                              const button = document.createElement("div")
                              button.innerHTML = "Jetzt anhängen"
                              button.style.backgroundColor = "#f7aa20"
                              button.style.cursor = "pointer"
                              button.style.fontSize = "21px"
                              button.style.fontFamily = "sans-serif"
                              button.style.borderRadius = "13px"
                              button.style.margin = "21px 34px"
                              button.style.display = "flex"
                              button.style.justifyContent = "center"
                              button.style.alignItems = "center"
                              button.style.height = "89px"
                              button.style.color = "#000"
                              button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                              button.addEventListener("click", async () => {

                                const elementString = htmlField.validValue()

                                const parser = document.createElement("div")
                                parser.innerHTML = elementString
                                while (parser.firstChild) {
                                  document.head.append(parser.firstChild)
                                }

                                Helper.removeOverlay(overlay)

                              })
                              funnel.append(button)
                            }



                          })


                        })

                      }

                    })




                  })

                  const left = document.createElement("div")
                  left.innerHTML = "document.head"
                  left.style.margin = "21px 34px"
                  left.style.fontSize = "21px"
                  left.style.fontFamily = "sans-serif"
                  button.append(left)

                  const title = document.createElement("div")
                  title.innerHTML = "Dokumentenkopf"
                  title.style.margin = "21px 34px"
                  title.style.fontSize = "13px"
                  title.style.fontFamily = "sans-serif"
                  button.append(title)

                  buttons.append(button)
                }

                {
                  const button = document.createElement("div")
                  button.style.display = "flex"
                  button.style.flexWrap = "wrap"
                  button.style.justifyContent = "space-between"
                  button.style.alignItems = "center"
                  button.style.margin = "21px 34px"
                  button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"
                  button.style.borderRadius = "13px"
                  button.style.border = "0.3px solid black"
                  button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                  button.style.cursor = "pointer"

                  button.addEventListener("click", () => {

                    Helper.popup(async overlay => {

                      overlay.classList.add("overlay-2")
                      const overlay2 = overlay

                      Helper.headerPicker("removeOverlay", overlay)
                      const elementInfo = Helper.headerPicker("elementInfo", overlay)

                      elementInfo.append(Helper.convert("element/alias", document.body))

                      const buttons = document.createElement("div")
                      buttons.style.overflowY = "auto"
                      buttons.style.paddingBottom = "144px"
                      buttons.style.overscrollBehavior = "none"
                      overlay.append(buttons)

                      {
                        const button = document.createElement("div")
                        button.style.display = "flex"
                        button.style.flexWrap = "wrap"
                        button.style.justifyContent = "space-between"
                        button.style.alignItems = "center"
                        button.style.margin = "21px 34px"
                        button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"

                        button.style.borderRadius = "13px"
                        button.style.border = "0.3px solid black"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.style.cursor = "pointer"

                        button.addEventListener("click", async () => {

                          if (document.body.children.length > 0) {

                            Helper.popup(overlay => {

                              overlay.classList.add("overlay-3")
                              const overlay3 = overlay

                              Helper.headerPicker("removeOverlay", overlay)
                              const elementInfo = Helper.headerPicker("elementInfo", overlay)

                              elementInfo.append(Helper.convert("element/alias", document.body))

                              const span = document.createElement("span")
                              span.innerHTML = ".children"
                              span.style.fontSize = "13px"
                              span.style.fontFamily = "monospace"
                              elementInfo.append(span)

                              Helper.renderChildren(document.body, overlay)

                            })

                          } else alert("Das HTML Element ist leer.")


                        })

                        const left = document.createElement("div")
                        left.innerHTML = ".children"
                        left.style.margin = "21px 34px"
                        left.style.fontSize = "21px"
                        left.style.fontFamily = "sans-serif"
                        button.append(left)

                        const title = document.createElement("div")
                        title.innerHTML = "Element Inhalt"
                        title.style.margin = "21px 34px"
                        title.style.fontSize = "13px"
                        title.style.fontFamily = "sans-serif"
                        button.append(title)

                        buttons.append(button)
                      }

                      {
                        const button = document.createElement("div")
                        button.style.display = "flex"
                        button.style.flexWrap = "wrap"
                        button.style.justifyContent = "space-between"
                        button.style.alignItems = "center"
                        button.style.margin = "21px 34px"
                        button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"

                        button.style.borderRadius = "13px"
                        button.style.border = "0.3px solid black"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.style.cursor = "pointer"
                        button.addEventListener("click", () => {

                          Helper.popup(async overlay => {

                            Helper.headerPicker("removeOverlay", overlay)


                            const elementInfo = Helper.headerPicker("elementInfo", overlay)

                            elementInfo.append(Helper.convert("element/alias", document.body))

                            const span = document.createElement("span")
                            span.innerHTML = ".templates"
                            span.style.fontSize = "13px"
                            span.style.fontFamily = "monospace"
                            elementInfo.append(span)

                            {
                              const units = Helper.headerPicker("loading", overlay)

                              const get = {}
                              get.url = "/get/templates/closed/3/"
                              get.location = window.location.href
                              get.referer = document.referrer
                              get.localStorageEmail = await Request.email()
                              get.localStorageId = await Request.localStorageId()
                              const res = await Request.middleware(get)

                              if (res.status !== 200) {
                                Helper.reset(units)
                                Helper.convert("element/center", units)
                                units.style.zIndex = "-1"
                                units.style.fontFamily = "sans-serif"
                                units.innerHTML = `<span style="margin: 21px 34px;">Keine Templates gefunden.</span>`
                                throw new Error("values not found")
                              }

                              if (res.status === 200) {
                                const templates = JSON.parse(res.response)

                                // console.log(templates);

                                if (templates.length === 0) {
                                  Helper.reset(units)
                                  Helper.convert("element/center", units)
                                  units.style.zIndex = "-1"
                                  units.style.fontFamily = "sans-serif"
                                  units.innerHTML = `<span style="margin: 21px 34px;">Keine Templates gefunden.</span>`
                                  throw new Error("platform templates is empty")
                                }

                                Helper.reset(units)
                                units.style.overflowY = "auto"
                                units.style.paddingBottom = "144px"
                                units.style.overscrollBehavior = "none"

                                // sort with reputation best on top as default





                                // Helper.render("templates", templates)
                                for (let i = 0; i < templates.length; i++) {
                                  const template = templates[i]

                                  // console.log(template);

                                  const item = document.createElement("div")
                                  // item.classList.add("checklist-item")
                                  item.style.margin = "34px"

                                  const itemHeader = document.createElement("div")
                                  // itemHeader.classList.add("item-header")
                                  itemHeader.style.display = "flex"
                                  itemHeader.style.borderTopRightRadius = "21px"
                                  itemHeader.style.borderTopLeftRadius = "21px"
                                  itemHeader.style.borderBottomLeftRadius = "21px"
                                  itemHeader.style.fontFamily = "sans-serif"

                                  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                    itemHeader.style.backgroundColor = Helper.colors.matte.charcoal
                                    itemHeader.style.color = Helper.colors.matte.dark.text

                                  } else {
                                    itemHeader.style.color = Helper.colors.matte.light.text
                                    itemHeader.style.backgroundColor = Helper.colors.gray[1]
                                  }




                                  const itemState = document.createElement("div")
                                  itemState.classList.add("item-state")
                                  itemState.style.display = "flex"
                                  itemState.style.justifyContent = "center"
                                  itemState.style.alignItems = "center"
                                  itemState.style.width = "89px"
                                  itemState.style.height = "89px"
                                  itemState.style.fontSize = "34px"

                                  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                    itemState.style.backgroundColor = Helper.colors.dark.foreground
                                  } else {
                                    itemState.style.backgroundColor = Helper.colors.light.foreground
                                  }

                                  if (document.getElementById(template.id) !== null) {
                                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                      itemState.style.backgroundColor = Helper.colors.dark.success
                                    } else {
                                      itemState.style.backgroundColor = Helper.colors.light.success
                                    }
                                  }

                                  itemState.style.borderTopLeftRadius = "21px"
                                  itemState.style.borderBottomLeftRadius = "21px"

                                  // append reputation in state
                                  const reputation = document.createElement("div")
                                  reputation.innerHTML = template.reputation
                                  reputation.style.fontSize = "34px"
                                  // reputation.style.fontFamily = "sans-serfi"

                                  // if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                  //   reputation.style.color = Helper.colors.matte.dark.text
                                  // } else {
                                  //   reputation.style.color = Helper.colors.matte.light.text
                                  // }

                                  itemState.append(reputation)


                                  const itemTitle = document.createElement("div")
                                  // itemTitle.classList.add("item-title")
                                  itemTitle.style.alignSelf = "center"
                                  itemTitle.style.marginLeft = "13px"
                                  // itemTitle.innerHTML = `${template.alias}`
                                  // itemTitle.style.fontSize = "21px"

                                  {
                                    const alias = document.createElement("div")
                                    alias.innerHTML = template.alias
                                    alias.style.fontSize = "21px"
                                    itemTitle.append(alias)
                                  }

                                  {
                                    const creator = document.createElement("div")
                                    creator.innerHTML = template.id
                                    creator.style.fontSize = "13px"
                                    itemTitle.append(creator)
                                  }

                                  // {
                                  //   const id = document.createElement("div")
                                  //   id.innerHTML = `${template.id}`
                                  //   id.style.fontSize = "13px"
                                  //   itemTitle.append(id)
                                  // }


                                  itemHeader.append(itemState, itemTitle)
                                  item.append(itemHeader)


                                  const itemBody = document.createElement("div")
                                  itemBody.classList.add("item-body")
                                  itemBody.style.marginLeft = "8%"


                                  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                    itemBody.style.backgroundColor = Helper.colors.matte.slate
                                    itemBody.style.boxShadow = `0 1px ${Helper.colors.gray[4]}`
                                  } else {
                                    itemBody.style.boxShadow = `0 1px ${Helper.colors.gray[2]}`
                                    itemBody.style.backgroundColor = Helper.colors.gray[0]
                                  }

                                  itemBody.style.borderBottomRightRadius = "21px"
                                  itemBody.style.borderBottomLeftRadius = "21px"
                                  itemBody.style.padding = "21px"
                                  itemBody.style.display = "flex"
                                  itemBody.style.flexDirection = "column"

                                  const buttons = document.createElement("div")
                                  buttons.style.display = "flex"
                                  buttons.style.alignItems = "center"


                                  // buttons for values
                                  // drop, preview, feedback, stats if exist


                                  {
                                    const button = Helper.iconPicker("repeat-once")
                                    button.style.width = "55px"
                                    button.style.padding = "8px"

                                    button.style.cursor = "pointer"
                                    button.addEventListener("click", () => {

                                      if (document.getElementById(template.id) === null) {
                                        const parser = document.createElement("div")
                                        parser.innerHTML = template.script
                                        const node = parser.firstChild
                                        const script = document.createElement("script")
                                        script.id = template.id
                                        script.innerHTML = node.innerHTML
                                        script.type = "module"
                                        script.append(`document.getElementById("${script.id}").remove()`)
                                        document.body.append(script)
                                        // script.remove()

                                      } else {
                                        alert("Id existiert bereits.")
                                      }

                                    })
                                    buttons.append(button)
                                  }


                                  {
                                    const button = Helper.iconPicker("repeat-always")
                                    button.style.width = "55px"
                                    button.style.padding = "8px"
                                    button.style.cursor = "pointer"
                                    button.addEventListener("click", () => {


                                      if (document.getElementById(template.id) === null) {
                                        const parser = document.createElement("div")
                                        parser.innerHTML = template.script
                                        const node = parser.firstChild
                                        const script = document.createElement("script")
                                        script.id = template.id
                                        script.type = "module"
                                        script.innerHTML = node.innerHTML
                                        document.body.append(script)
                                        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                          itemState.style.backgroundColor = Helper.colors.dark.success
                                        } else {
                                          itemState.style.backgroundColor = Helper.colors.light.success
                                        }
                                      } else {
                                        alert("Id existiert bereits.")
                                      }

                                    })
                                    buttons.append(button)
                                  }

                                  {

                                    const button = document.createElement("div")
                                    button.style.cursor = "pointer"
                                    button.style.position = "relative"
                                    button.addEventListener("click", () => {

                                      Helper.popup(async overlay => {
                                        const feedbackOverlay = overlay

                                        Helper.headerPicker("removeOverlay", overlay)

                                        const elementInfo = Helper.headerPicker("elementInfo", overlay)

                                        elementInfo.append(Helper.convert("element/alias", document.body))

                                        const span = document.createElement("span")
                                        span.innerHTML = `.templates[${i}].feedback`
                                        span.style.fontSize = "13px"
                                        span.style.fontFamily = "monospace"
                                        elementInfo.append(span)

                                        const content = document.createElement("div")
                                        content.style.overflowY = "auto"
                                        content.style.overscrollBehavior = "none"
                                        content.style.paddingBottom = "144px"
                                        overlay.append(content)

                                        const feedbackContainer = Helper.headerPicker("loading", content)
                                        feedbackContainer.info.remove()

                                        feedbackContainer.style.margin = "21px 34px"
                                        feedbackContainer.style.overflowY = "auto"
                                        feedbackContainer.style.overscrollBehavior = "none"
                                        feedbackContainer.style.fontFamily = "monospace"
                                        feedbackContainer.style.fontSize = "13px"
                                        feedbackContainer.style.height = `${window.innerHeight * 0.4}px`


                                        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                          feedbackContainer.style.color = Helper.colors.dark.text
                                        } else {
                                          feedbackContainer.style.color = Helper.colors.light.text
                                        }

                                        const get = {}
                                        get.url = "/get/templates/closed/3/"
                                        get.type = "feedback"
                                        get.id = template.id
                                        get.location = window.location.href
                                        get.referer = document.referrer
                                        get.localStorageEmail = await Request.email()
                                        get.localStorageId = await Request.localStorageId()
                                        const res = await Request.middleware(get)

                                        if (res.status !== 200) {
                                          feedbackContainer.innerHTML = `<span style="margin: 21px 34px;">Kein Feedback gefunden.</span>`
                                          throw new Error("feedback not found")
                                        }

                                        getFeedbackSuccess: if (res.status === 200) {
                                          const feedback = JSON.parse(res.response)

                                          if (feedback.length === 0) {
                                            feedbackContainer.innerHTML = `<span style="margin: 21px 34px;">Kein Feedback gefunden.</span>`
                                            break getFeedbackSuccess
                                          }

                                          Helper.reset(feedbackContainer)
                                          feedbackContainer.style.margin = "21px 34px"
                                          feedbackContainer.style.overflowY = "auto"
                                          feedbackContainer.style.overscrollBehavior = "none"
                                          feedbackContainer.style.fontFamily = "monospace"
                                          feedbackContainer.style.fontSize = "13px"
                                          feedbackContainer.style.height = `${window.innerHeight * 0.4}px`

                                          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                            feedbackContainer.style.color = Helper.colors.dark.text
                                          } else {
                                            feedbackContainer.style.color = Helper.colors.light.text
                                          }


                                          for (let i = 0; i < feedback.length; i++) {
                                            const value = feedback[i]

                                            const div = document.createElement("div")
                                            div.style.display = "flex"
                                            div.style.justifyContent = "space-between"
                                            div.style.alignItems = "center"

                                            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {

                                              if (i % 2 === 0) {
                                                div.style.background = Helper.colors.light.foreground
                                                div.style.color = Helper.colors.light.text
                                              } else {
                                                div.style.background = Helper.colors.dark.foreground
                                                div.style.color = Helper.colors.dark.text
                                              }

                                            } else {

                                              if (i % 2 === 1) {
                                                div.style.background = Helper.colors.light.foreground
                                                div.style.color = Helper.colors.light.text
                                              } else {
                                                div.style.background = Helper.colors.dark.foreground
                                                div.style.color = Helper.colors.dark.text
                                              }

                                            }

                                            const left = document.createElement("span")
                                            left.innerHTML = `${Helper.convert("millis/dd.mm.yyyy hh:mm", value.created)}`
                                            div.append(left)

                                            const nextToLeft = document.createElement("span")
                                            nextToLeft.style.width = "100%"
                                            nextToLeft.style.margin = "0 13px"
                                            nextToLeft.innerHTML = value.content
                                            div.append(nextToLeft)

                                            const right = document.createElement("span")
                                            right.style.padding = "13px"
                                            right.innerHTML = value.importance
                                            div.append(right)

                                            feedbackContainer.append(div)

                                            div.style.cursor = "pointer"
                                            div.addEventListener("click", () => {

                                              Helper.popup(overlay => {
                                                Helper.headerPicker("removeOverlay", overlay)

                                                const button = Helper.buttonPicker("left/right", overlay)
                                                const icon = Helper.iconPicker("delete")
                                                icon.style.width = "34px"
                                                button.left.append(icon)
                                                button.right.innerHTML = "Feedback löschen"

                                                button.addEventListener("click", async () => {
                                                  const confirm = window.confirm("Möchtest du diesen Beitrag wirklich löschen?")

                                                  if (confirm === true) {
                                                    const del = {}
                                                    del.url = "/delete/feedback/closed/3/"
                                                    del.type = "template"
                                                    del.id = template.id
                                                    del.created = value.created
                                                    del.location = window.location.href
                                                    del.referer = document.referrer
                                                    del.localStorageEmail = await Request.email()
                                                    del.localStorageId = await Request.localStorageId()
                                                    const res = await Request.middleware(del)

                                                    if (res.status === 200) {
                                                      alert("Beitrag erfolgreich gelöscht.")
                                                      length.innerHTML = template.feedbackLength - 1
                                                      Helper.removeOverlay(overlay)
                                                      Helper.removeOverlay(feedbackOverlay)
                                                    } else {
                                                      alert("Fehler.. Bitte wiederholen.")
                                                      Helper.removeOverlay(overlay)
                                                    }


                                                  }

                                                })
                                              })

                                            })
                                          }


                                        }

                                        const contentField = new TextField("feedback", content)
                                        contentField.label.innerHTML = "Feedback"
                                        contentField.input.required = true
                                        contentField.input.maxLength = "55"
                                        contentField.verifyValue()
                                        contentField.input.addEventListener("input", () => contentField.verifyValue())

                                        const importanceField = new RangeField("importance", content)
                                        importanceField.input.min = "0"
                                        importanceField.input.max = "13"
                                        importanceField.input.step = "1"
                                        importanceField.input.value = "0"
                                        importanceField.label.innerHTML = `Wichtigkeit - ${importanceField.input.value}`
                                        importanceField.verifyValue()
                                        importanceField.input.addEventListener("input", (event) => {
                                          importanceField.verifyValue()
                                          importanceField.label.innerHTML = `Wichtigkeit - ${event.target.value}`
                                        })

                                        const button = Helper.buttonPicker("action", content)
                                        button.innerHTML = "Jetzt speichern"
                                        button.addEventListener("click", () => {

                                          const importance = importanceField.validValue()
                                          const content = contentField.validValue()


                                          Helper.popup(async securityOverlay => {

                                            Helper.headerPicker("loading", securityOverlay)

                                            const register = {}
                                            register.url = "/register/feedback/closed/3/"
                                            register.type = "template"
                                            register.id = template.id
                                            register.importance = importance
                                            register.content = content
                                            register.location = window.location.href
                                            register.referer = document.referrer
                                            register.localStorageEmail = await Request.email()
                                            register.localStorageId = await Request.localStorageId()
                                            const res = await Request.middleware(register)

                                            if (res.status === 200) {
                                              alert("Feedback erfolgreich gespeichert.")
                                              Helper.removeOverlay(securityOverlay)
                                              Helper.removeOverlay(overlay)
                                              length.innerHTML = template.feedbackLength + 1
                                            } else {
                                              alert("Fehler.. Bitte wiederholen.")
                                              Helper.removeOverlay(securityOverlay)
                                            }

                                          })


                                        })



                                      })

                                    })


                                    const icon = Helper.iconPicker("branch")
                                    icon.style.width = "55px"
                                    button.append(icon)

                                    const length = document.createElement("div")
                                    length.style.position = "absolute"
                                    length.style.top = "0"
                                    length.style.right = "0"
                                    length.style.fontFamily = "monospace"
                                    length.style.fontSize = "13px"
                                    length.style.borderRadius = "50%"
                                    length.style.padding = "3px 5px"
                                    length.innerHTML = template.feedbackLength

                                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                      length.style.color = Helper.colors.dark.text
                                      length.style.background = Helper.colors.dark.foreground
                                    } else {
                                      length.style.color = Helper.colors.light.text
                                      length.style.background = Helper.colors.light.foreground
                                    }
                                    button.append(length)
                                    buttons.append(button)
                                  }

                                  itemBody.append(buttons)
                                  item.append(itemBody)
                                  units.append(item)
                                }



                              }

                            }

                          })

                        })

                        const left = document.createElement("div")
                        left.innerHTML = ".templates"
                        left.style.margin = "21px 34px"
                        left.style.fontSize = "21px"
                        left.style.fontFamily = "sans-serif"
                        button.append(left)

                        const title = document.createElement("div")
                        title.innerHTML = "Template anhängen"
                        title.style.margin = "21px 34px"
                        title.style.fontSize = "13px"
                        title.style.fontFamily = "sans-serif"
                        button.append(title)

                        buttons.append(button)
                      }

                      {
                        const button = document.createElement("div")
                        button.style.display = "flex"
                        button.style.flexWrap = "wrap"
                        button.style.justifyContent = "space-between"
                        button.style.alignItems = "center"
                        button.style.margin = "21px 34px"
                        button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"
                        button.style.borderRadius = "13px"
                        button.style.border = "0.3px solid black"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.style.cursor = "pointer"
                        button.addEventListener("click", () => {

                          Helper.popup(overlay => {
                            overlay.classList.add("overlay-3")
                            const overlay3 = overlay

                            Helper.headerPicker("removeOverlay", overlay)

                            const elementInfo = Helper.headerPicker("elementInfo", overlay)

                            elementInfo.append(Helper.convert("element/alias", document.body))

                            const span = document.createElement("span")
                            span.innerHTML = ".style"
                            span.style.fontSize = "13px"
                            span.style.fontFamily = "monospace"
                            elementInfo.append(span)

                            const content = document.createElement("div")
                            content.style.overflowY = "auto"
                            content.style.overscrollBehavior = "none"
                            content.style.paddingBottom = "144px"
                            overlay.append(content)

                            {
                              const divStylePropertyField = new TextField("divStyleProperty", content)
                              divStylePropertyField.label.innerHTML = "CSS Eigenschaft"
                              divStylePropertyField.input.required = true
                              divStylePropertyField.input.addEventListener("input", (event) => {
                                if (event.target.style[event.target.value] !== undefined) {
                                  Helper.setValidStyle(event.target)
                                } else {
                                  Helper.setNotValidStyle(event.target)
                                }
                              })

                              const divStyleValueField = new TextField("divStyleValue", content)
                              divStyleValueField.label.innerHTML = "CSS Wert"
                              divStyleValueField.input.addEventListener("input", () => {
                                divStyleValueField.verifyValue()
                              })


                              {
                                const button = document.createElement("div")
                                button.innerHTML = "CSS anwenden"
                                button.style.backgroundColor = "#f7aa20"
                                button.style.cursor = "pointer"
                                button.style.fontSize = "21px"
                                button.style.fontFamily = "sans-serif"
                                button.style.borderRadius = "13px"
                                button.style.margin = "21px 34px"
                                button.style.display = "flex"
                                button.style.justifyContent = "center"
                                button.style.alignItems = "center"
                                button.style.height = "89px"
                                button.style.color = "#000"
                                button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                                button.addEventListener("click", () => {

                                  try {
                                    divStylePropertyField.validValue()
                                    if (divStylePropertyField.input.style[divStylePropertyField.input.value] === undefined) throw new Error("css property not found")
                                  } catch (error) {
                                    alert(`Die CSS Eigenschaft ist ungültig.`)
                                    Helper.setNotValidStyle(divStylePropertyField.input)
                                    throw error
                                  }

                                  const cssValue = divStyleValueField.validValue()

                                  document.body.style[divStylePropertyField.input.value] = cssValue

                                  Helper.removeOverlay(overlay3)
                                  Helper.removeOverlay(overlay2)
                                  Helper.removeOverlay(overlay1)

                                })
                                content.append(button)
                              }

                            }


                          })
                        })

                        const left = document.createElement("div")
                        left.innerHTML = ".style"
                        left.style.margin = "21px 34px"
                        left.style.fontSize = "21px"
                        left.style.fontFamily = "sans-serif"
                        button.append(left)

                        const title = document.createElement("div")
                        title.innerHTML = "Style anpassen"
                        title.style.margin = "21px 34px"
                        title.style.fontSize = "13px"
                        title.style.fontFamily = "sans-serif"
                        button.append(title)

                        buttons.append(button)
                      }

                      {

                        const button = Helper.buttonPicker("left/right", buttons)
                        button.left.innerHTML = ".append"
                        button.right.innerHTML = "Element anhängen"

                        button.addEventListener("click", () => {

                          Helper.popup(overlay => {
                            const overlay3 = overlay

                            Helper.headerPicker("removeOverlay", overlay)

                            const elementInfo = Helper.headerPicker("elementInfo", overlay)
                            elementInfo.append(Helper.convert("element/alias", document.body))

                            const span = document.createElement("span")
                            span.textContent = ".append"
                            span.style.fontSize = "13px"
                            span.style.fontFamily = "monospace"

                            elementInfo.append(span)

                            {
                              const funnel = document.createElement("div")
                              funnel.style.overflowY = "auto"
                              funnel.style.overscrollBehavior = "none"
                              funnel.style.paddingBottom = "144px"
                              overlay.append(funnel)

                              const htmlField = new TextAreaField("html-input", funnel)
                              htmlField.label.innerHTML = "HTML Element"
                              htmlField.label.style.fontFamily = "sans-serif"
                              htmlField.input.style.fontSize = "13px"
                              htmlField.input.style.height = "89px"
                              htmlField.input.placeholder = `<div>..</div>`
                              htmlField.input.addEventListener("input", () => {
                                htmlField.verifyValue()
                              })

                              const button = document.createElement("div")
                              button.innerHTML = "Jetzt anhängen"
                              button.style.backgroundColor = "#f7aa20"
                              button.style.cursor = "pointer"
                              button.style.fontSize = "21px"
                              button.style.fontFamily = "sans-serif"
                              button.style.borderRadius = "13px"
                              button.style.margin = "21px 34px"
                              button.style.display = "flex"
                              button.style.justifyContent = "center"
                              button.style.alignItems = "center"
                              button.style.height = "89px"
                              button.style.color = "#000"
                              button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                              button.addEventListener("click", async () => {

                                const elementString = htmlField.validValue()

                                const parser = document.createElement("div")
                                parser.innerHTML = elementString

                                while (parser.firstChild) {
                                  document.body.append(parser.firstChild)
                                }

                                Helper.removeOverlay(overlay)

                              })
                              funnel.append(button)
                            }



                          })


                        })

                      }

                    })

                  })

                  const left = document.createElement("div")
                  left.innerHTML = "document.body"
                  left.style.margin = "21px 34px"
                  left.style.fontSize = "21px"
                  left.style.fontFamily = "sans-serif"
                  button.append(left)

                  const title = document.createElement("div")
                  title.innerHTML = "Dokumenteninhalt"
                  title.style.margin = "21px 34px"
                  title.style.fontSize = "13px"
                  title.style.fontFamily = "sans-serif"
                  button.append(title)

                  buttons.append(button)
                }

              })

            })

            // observe ids in document
            const observer = new MutationObserver((mutations, observer) => {

              for (let i = 0; i < mutations.length; i++) {
                const mutation = mutations[i]

                // on nodes added
                // mutation.addedNodes.forEach(node => {
                //   const nodes = document.querySelectorAll("*[id]")
                //   for (let i = 0; i < nodes.length; i++) {
                //     const element = nodes[i]
                //     if (element.id === node.id) {
                //       if (element.tagName === "SCRIPT") continue
                //       document.querySelectorAll(`#${node.id}`).forEach(element => {
                //         element.style.border = `2px dashed ${Helper.colors.matte.light.error}`
                //       })
                //     }
                //   }
                // })

                // on id change
                if (mutation.type === 'attributes' && mutation.attributeName === 'id') {
                  const ids = document.querySelectorAll(`#${mutation.target.id}`)
                  if (ids[1] !== undefined) {
                    ids[0].style.border = `2px dashed ${Helper.colors.matte.light.error}`
                    ids[1].style.border = `2px dashed ${Helper.colors.matte.light.error}`
                  } else {
                    if (ids[0].style.border === "2px dashed rgb(176, 53, 53)") {
                      ids[0].style.border = null
                    }
                  }
                }

              }

            })

            observer.observe(document.documentElement, {
              childList: true,
              subtree: true,
              attributes: true,
            })

          }

        }

      }

    }
  }

</script>
