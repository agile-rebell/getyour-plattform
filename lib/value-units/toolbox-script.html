<script id="toolbox" type="module">

  import {Request} from "/js/Request.js"
  import {Helper} from "/js/Helper.js"
  import {FileField} from "/js/FileField.js"
  import {TextField} from "/js/TextField.js"
  import {SelectionField} from "/js/SelectionField.js"
  import {TextAreaField} from "/js/TextAreaField.js"
  import {RangeField} from "/js/RangeField.js"


  const localStoragId = window.localStorage.getItem("localStorageId")
  if (localStoragId !== null) {
    const localStorageEmail = window.localStorage.getItem("email")
    if (localStorageEmail !== null) {

      {
        const verify = {}
        verify.url = "/verify/expert/closed/3/"
        verify.event = "toolbox"
        verify.localStorageId = await Request.localStorageId()
        verify.localStorageEmail = await Request.email()
        verify.location = window.location.href
        verify.referer = document.referrer
        const res = await Request.middleware(verify)

        if (res.status === 200) {

          {
            const toolbox = Helper.iconPicker("getyour")
            toolbox.setAttribute("data-id", "toolbox")
            toolbox.style.position = "fixed"
            toolbox.style.bottom = "0"
            toolbox.style.right = "0"

            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              toolbox.style.boxShadow = "0 3px 5px rgba(255, 255, 255, 0.13)"
              toolbox.style.border = `0.3px solid ${Helper.colors.matte.dark.accent}`
              toolbox.style.backgroundColor = Helper.colors.matte.dark.background
            } else {
              toolbox.style.boxShadow = "0 3px 5px rgba(0, 0, 0, 0.13)"
              toolbox.style.border = `0.3px solid ${Helper.colors.matte.light.accent}`
              toolbox.style.backgroundColor = Helper.colors.matte.light.background
            }

            toolbox.style.width = "34px"
            toolbox.style.height = "34px"
            toolbox.style.borderRadius = "50%"
            toolbox.style.margin = "21px 34px"
            toolbox.style.padding = "21px"
            toolbox.style.zIndex = "1"
            toolbox.style.cursor = "pointer"
            document.body.insertBefore(toolbox, document.querySelector("#toolbox"))

            toolbox.addEventListener("click", () => {

              Helper.popup(async overlay => {
                overlay.classList.add("overlay-1")
                const overlay1 = overlay

                {
                  const show = document.createElement("img")
                  show.src = "/public/show.svg"
                  show.alt = "Vorschau"
                  show.style.position = "absolute"
                  show.style.left = "0"
                  show.style.bottom = "0"
                  show.style.width = "55px"
                  show.style.padding = "13px"
                  show.style.margin = "21px 34px"
                  show.style.border = "0.3px solid black"
                  show.style.borderRadius = "50%"
                  show.style.backgroundColor = "#fff"
                  show.style.boxShadow = "0px 5px 8px rgba(0, 0, 0, 0.21)"
                  show.style.zIndex = "999"
                  show.style.cursor = "pointer"
                  show.addEventListener("click", () => Helper.removeOverlay(overlay))
                  overlay.append(show)

                  const save = document.createElement("img")
                  save.src = "/public/save.svg"
                  save.alt = "Speichern"
                  save.style.position = "absolute"
                  save.style.right = "0"
                  save.style.bottom = "0"
                  save.style.width = "55px"
                  save.style.padding = "13px"
                  save.style.margin = "21px 34px"
                  save.style.border = "0.3px solid black"
                  save.style.backgroundColor = "#fff"
                  save.style.borderRadius = "50%"
                  save.style.boxShadow = "0px 5px 8px rgba(0, 0, 0, 0.21)"
                  save.style.zIndex = "999"
                  save.style.cursor = "pointer"
                  save.addEventListener("click", async () => {

                    const toolboxScript = document.getElementById("toolbox")
                    const dataIds = document.querySelectorAll("[data-id]")
                    try {

                      dataIds.forEach(element => element.remove())
                      toolboxScript.remove()
                      overlay.remove()
                      // document.body.removeAttribute("style")
                      document.body.style.overscrollBehavior = null
                      document.body.style.overflow = null

                      const register = {}
                      register.url = "/register/platform-value/closed/3/"
                      register.type = "html"
                      register.html = document.documentElement.outerHTML.replace(/<html>/, "<!DOCTYPE html><html>")
                      register.localStorageId = await Request.localStorageId()
                      register.localStorageEmail = await Request.email()
                      register.location = window.location.href
                      register.referer = document.referrer
                      await Request.sequence(register)

                      window.location.reload()
                    } catch (error) {
                      for (let i = 0; i < dataIds.length; i++) {
                        const dataId = dataIds[i]
                        document.body.insertBefore(dataId, document.querySelector(`script[id='${dataId.getAttribute("data-id")}']`))
                      }
                      alert("Fehler.. Bitte wiederholen.")
                    }

                  })
                  overlay.append(save)

                }

                const buttons = document.createElement("div")
                buttons.style.overflow = "auto"
                buttons.style.overscrollBehavior = "none"
                buttons.style.paddingBottom = "144px"
                overlay.append(buttons)

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "document.children"
                  button.right.innerHTML = "Dokumenten Inhalt"
                  button.addEventListener("click", () => {
                    Helper.popup(overlay => {
                      Helper.headerPicker("removeOverlay", overlay)
                      const info = Helper.headerPicker("info", overlay)
                      info.innerHTML = "document.children"


                      const childrenContainer = Helper.headerPicker("scrollable", overlay)
                      Helper.render("children", document.documentElement, childrenContainer)


                    })
                  })
                }

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "document.write"
                  button.right.innerHTML = "Aktuelles Dokument ersetzen"

                  button.addEventListener("click", () => {

                    Helper.popup(overlay => {

                      Helper.headerPicker("removeOverlay", overlay)

                      {
                        const funnel = document.createElement("div")
                        funnel.style.overflow = "auto"
                        funnel.style.overscrollBehavior = "none"
                        funnel.style.paddingBottom = "144px"
                        overlay.append(funnel)

                        const htmlField = new TextAreaField("htm-l", funnel)
                        htmlField.label.innerHTML = "HTML Dokument"
                        htmlField.label.style.fontFamily = "sans-serif"
                        htmlField.input.style.fontSize = "13px"
                        htmlField.input.style.height = "89px"
                        htmlField.input.placeholder = `<html>..</html>`
                        htmlField.input.addEventListener("input", () => {
                          htmlField.verifyValue()
                        })

                        const button = document.createElement("div")
                        button.innerHTML = "Jetzt ersetzen"
                        button.style.backgroundColor = "#f7aa20"
                        button.style.cursor = "pointer"
                        button.style.fontSize = "21px"
                        button.style.fontFamily = "sans-serif"
                        button.style.borderRadius = "13px"
                        button.style.margin = "21px 34px"
                        button.style.display = "flex"
                        button.style.justifyContent = "center"
                        button.style.alignItems = "center"
                        button.style.height = "89px"
                        button.style.color = "#000"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.addEventListener("click", async () => {

                          const html = htmlField.validValue()

                          const confirm = window.confirm("Achtung! Diese Funktion wird dein aktuelles HTML Dokument mit deinem neuen HTML Import ersetzen. Der Inhalt deines aktuellen Dokuments wird unwideruflich gelöscht, sobald du deine Werteinheit abspeicherst.\n\n Möchtest du dein aktuelles HTML Dokument wirklich ersetzen?")
                          if (confirm === true) {

                            const toolbox = document.getElementById("toolbox").cloneNode(true)

                            document.open()
                            document.write(html)
                            document.close()

                            const script = document.createElement("script")
                            script.id = toolbox.id
                            script.type = toolbox.type
                            script.innerHTML = toolbox.innerHTML
                            document.body.append(script)

                          }

                          Helper.removeOverlay(overlay)

                        })
                        funnel.append(button)
                      }



                    })


                  })

                }

                {
                  const button = Helper.buttonPicker("left/right", buttons)
                  button.left.innerHTML = "template.import"
                  button.right.innerHTML = "HTML Script importieren"
                  button.addEventListener("click", () => {

                    Helper.popup(overlay => {

                      Helper.headerPicker("removeOverlay", overlay)

                      {
                        const funnel = document.createElement("div")
                        funnel.style.overflow = "auto"
                        funnel.style.overscrollBehavior = "none"
                        funnel.style.paddingBottom = "144px"
                        overlay.append(funnel)

                        const htmlField = new TextAreaField("script-import", funnel)
                        htmlField.label.innerHTML = "HTML Script Element"
                        htmlField.label.style.fontFamily = "sans-serif"
                        htmlField.input.required = true
                        htmlField.input.style.fontSize = "13px"
                        htmlField.input.style.height = "89px"
                        htmlField.input.placeholder = `<script id=".." alias=".." >..</>`
                        htmlField.input.addEventListener("input", () => {
                          htmlField.verifyValue()
                        })

                        const button = document.createElement("div")
                        button.innerHTML = "Jetzt als Template speichern"
                        button.style.backgroundColor = "#f7aa20"
                        button.style.cursor = "pointer"
                        button.style.fontSize = "21px"
                        button.style.fontFamily = "sans-serif"
                        button.style.borderRadius = "13px"
                        button.style.margin = "21px 34px"
                        button.style.display = "flex"
                        button.style.justifyContent = "center"
                        button.style.alignItems = "center"
                        button.style.height = "89px"
                        button.style.color = "#000"
                        button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                        button.addEventListener("click", async () => {

                          const html = htmlField.validValue()

                          const parser = document.createElement("div")
                          parser.innerHTML = html


                          if (parser.children.length > 1) {
                            alert("Es kann nur ein HTML Script Element auf einmal gespeichert werden.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`too many children`)
                          }



                          const node = parser.firstChild

                          if (node.tagName !== "SCRIPT") {
                            alert("Es können nur HTML Script Elemente als Templates gespeichert werden. Der von dir bereitgestellte Code ist kein HTML Script Element.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`not a script`)
                          }

                          if (Helper.stringIsEmpty(node.id)) {
                            alert("HTML Script Element benötigt eine Id.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`id is empty`)
                          }

                          if (!Helper.verifyIs("text/tag", node.id)) {
                            alert("Id muss vom 'tag' Format sein. Es sind nur Kleinbuchstaben (a-z) und Bindestriche dazwischen erlaubt. (-)")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`id is not a tag`)
                          }

                          const verify = {}
                          verify.url = "/verify/template/closed/3/"
                          verify.type = "id"
                          verify.id = node.id
                          verify.localStorageId = await Request.localStorageId()
                          verify.localStorageEmail = await Request.email()
                          verify.location = window.location.href
                          verify.referer = document.referrer
                          const res = await Request.middleware(verify)

                          if (res.status === 200) {
                            alert("Id existiert bereits.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`id exist`)
                          }

                          if (Helper.stringIsEmpty(node.getAttribute("alias"))) {
                            alert("HTML Script Element benötigt eine Alias.")
                            Helper.setNotValidStyle(htmlField.input)
                            throw new Error(`alias is empty`)
                          }

                          const script = document.createElement("script")
                          script.innerHTML = node.innerHTML

                          Helper.popup(async securityOverlay => {
                            Helper.headerPicker("loading", securityOverlay)
                            const register = {}
                            register.url = "/register/template/closed/3/"
                            register.id = node.id
                            register.alias = node.getAttribute("alias")
                            register.script = script.outerHTML
                            register.localStorageId = await Request.localStorageId()
                            register.localStorageEmail = await Request.email()
                            register.location = window.location.href
                            register.referer = document.referrer
                            const res = await Request.middleware(register)

                            if (res.status === 200) {
                              alert("Template erfolgreich gespeichert.")
                              Helper.removeOverlay(securityOverlay)
                              Helper.removeOverlay(overlay)
                            } else {
                              alert("Fehler.. Bitte wiederholen.")
                              Helper.removeOverlay(securityOverlay)
                              Helper.setNotValidStyle(htmlField.input)
                              throw new Error(`register template failed`)
                            }
                          })

                        })
                        funnel.append(button)
                      }

                    })

                  })
                }

              })

            })

            // observe ids in document
            const observer = new MutationObserver((mutations, observer) => {

              for (let i = 0; i < mutations.length; i++) {
                const mutation = mutations[i]

                // on nodes added
                // mutation.addedNodes.forEach(node => {
                //   const nodes = document.querySelectorAll("*[id]")
                //   for (let i = 0; i < nodes.length; i++) {
                //     const element = nodes[i]
                //     if (element.id === node.id) {
                //       if (element.tagName === "SCRIPT") continue
                //       document.querySelectorAll(`#${node.id}`).forEach(element => {
                //         element.style.border = `2px dashed ${Helper.colors.matte.light.error}`
                //       })
                //     }
                //   }
                // })

                // on id change
                if (mutation.type === 'attributes' && mutation.attributeName === 'id') {
                  const ids = document.querySelectorAll(`#${mutation.target.id}`)
                  if (ids[1] !== undefined) {
                    ids[0].style.border = `2px dashed ${Helper.colors.matte.light.error}`
                    ids[1].style.border = `2px dashed ${Helper.colors.matte.light.error}`
                  } else {
                    if (ids[0].style.border === "2px dashed rgb(176, 53, 53)") {
                      ids[0].style.border = null
                    }
                  }
                }

              }

            })

            observer.observe(document.documentElement, {
              childList: true,
              subtree: true,
              attributes: true,
            })

          }

        }

      }

    }
  }

</script>
