<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="/public/getyour-logo.svg" />
    <title>Admin Bereich</title>

    <style>
      body {
        margin: 0;
        line-height: 1.2;
        overscroll-behavior: none;
        font-family: sans-serif;
      }
    </style>

  </head>
  <body>

    <script type="module">
      import { Request } from "/js/Request.js"
      import { Helper } from "/js/Helper.js"
      import { TextField } from "/js/TextField.js"
      import { EmailField } from "/js/EmailField.js"
      import { SelectionField } from "/js/SelectionField.js"
      import { TelField } from "/js/TelField.js"

      document.body.style.background = Helper.colors.light.background
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.style.background = Helper.colors.dark.background
      }

      Helper.render("text/title", "Admin", document.body)

      Helper.headerPicker("back", document.body)

      const app = Helper.headerPicker("app", document.body)
      app.addEventListener("click", () => {

        Helper.popup(async overlay => {
          Helper.headerPicker("removeOverlay", overlay)

          const buttons = Helper.create("div/scrollable", overlay)

          {

            {
              const button = Helper.buttonPicker("left/right", buttons)
              button.left.innerHTML = ".register-expert"
              button.right.innerHTML = "Neuen Experten registrieren"

              button.addEventListener("click", () => {

                Helper.popup(async overlay => {
                  Helper.headerPicker("removeOverlay", overlay)

                  {
                    const funnel = Helper.create("div/scrollable", overlay)

                    const nameField = new TextField("name", funnel)
                    nameField.label.innerHTML = "Name"
                    nameField.input.placeholder = "huansolo"
                    nameField.input.accept = "text/tag"
                    nameField.input.required = true
                    nameField.input.addEventListener("input", () => {
                      nameField.verifyValue()
                    })
                    nameField.verifyValue()

                    const emailField = new EmailField("email", funnel)
                    emailField.label.innerHTML = "E-Mail Adresse"
                    emailField.input.placeholder = "experte@email.de"
                    emailField.input.required = true
                    emailField.input.addEventListener("input", () => {
                      emailField.verifyValue()
                    })
                    emailField.verifyValue()

                    const button = Helper.buttonPicker("action", funnel)
                    button.innerHTML = "Experten jetzt registrieren"
                    button.addEventListener("click", async () => {

                      const username = nameField.validValue()
                      const email = emailField.validValue()

                      {
                        const verify = {}
                        verify.url = "/verify/expert/closed/2/"
                        verify.name = username
                        const res = await Request.closed(verify)

                        if (res.status === 200) {
                          alert("Experte existiert bereits.")
                          Helper.setNotValidStyle(nameField.input)
                          throw new Error("expert exist")
                        }
                      }


                      Helper.overlay("security", async securityOverlay => {

                        const register = {}
                        register.url = "/register/expert/closed/2/"
                        register.name = username
                        register.email = email
                        const res = await Request.closed(register)

                        if (res.status === 200) {
                          const send = {}
                          send.url = "/send/email/closed/2/"
                          send.email = email
                          send.event = "invite/expert"
                          const res = await Request.closed(send)

                          if (res.status === 200) {
                            window.alert("Experte erfolgreich angemeldet.")
                            Helper.removeOverlay(overlay)
                            Helper.removeOverlay(securityOverlay)
                          } else {
                            window.alert("Anmeldung nicht möglich. Mehr Infos in den Error Logs.")
                            Helper.removeOverlay(overlay)
                            Helper.removeOverlay(securityOverlay)
                          }


                        } else {
                          alert("Anmeldung nicht möglich. Mehr Infos in den Error Logs.")
                          Helper.removeOverlay(overlay)
                          Helper.removeOverlay(securityOverlay)
                        }

                      })

                    })

                  }

                })
              })
            }

            {

              const button = Helper.buttonPicker("left/right", buttons)
              button.left.innerHTML = ".errors"
              button.right.innerHTML = "Fehler Liste"

              button.addEventListener("click", () => {

                Helper.popup(async overlay => {
                  Helper.headerPicker("removeOverlay", overlay)



                  const getErrors = {}
                  getErrors.url = "/get/error/closed/2/"
                  getErrors.localStorageEmail = await Request.email()
                  getErrors.localStorageId = await Request.localStorageId()
                  getErrors.referer = document.referrer
                  getErrors.location = window.location.href
                  const res = await Request.middleware(getErrors)

                  if (res.status === 200) {
                    const errors = JSON.parse(res.response)

                    const buttons = Helper.create("div/scrollable", overlay)
                    buttons.style.overflowY = "scroll"
                    buttons.style.paddingBottom = "144px"
                    buttons.style.overscrollBehavior = "none"

                    for (let i = 0; i < errors.length; i++) {
                      const error = errors[i]


                      const button = Helper.buttonPicker("left/right", buttons)
                      // button.style.display = "flex"
                      // button.style.flexWrap = "wrap"
                      // button.style.alignItems = "center"
                      // button.style.margin = "21px 34px"
                      // button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"
                      // button.style.borderRadius = "13px"
                      // button.style.border = "0.3px solid black"
                      // button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"
                      // button.style.cursor = "pointer"
                      button.addEventListener("click", () => {

                        Helper.popup(overlay => {
                          Helper.headerPicker("removeOverlay", overlay)

                          // const header = document.createElement("div")
                          // header.style.position = "fixed"
                          // header.style.bottom = "0"
                          // header.style.left = "0"
                          // header.style.width = "100%"
                          // header.style.display = "flex"
                          // header.style.justifyContent = "flex-start"
                          // header.style.alignItems = "center"
                          // header.style.boxShadow = "0px 5px 10px rgba(0, 0, 0, 0.5)"
                          // header.style.background = "white"
                          // header.style.cursor = "pointer"
                          // header.addEventListener("click", () => Helper.removeOverlay(overlay))

                          // const logo = document.createElement("img")
                          // logo.src = "/public/getyour-logo.svg"
                          // logo.alt = "Getyour Popup"
                          // logo.style.margin = "21px 34px"
                          // header.append(logo)
                          // const title = document.createElement("div")
                          // title.innerHTML = error.message
                          // title.style.fontWeight = "bold"
                          // title.style.fontSize = "21px"
                          // header.append(title)
                          // overlay.append(header)
                          Helper.render("text/code", error.stack, overlay)

                          // const stack = document.createElement("div")
                          // stack.style.margin = "21px 34px"
                          // stack.innerHTML = error.stack
                          // overlay.append(stack)


                        })
                      })

                      button.left.innerHTML = ".error"
                      // const icon = document.createElement("img")
                      // icon.style.margin = "13px 34px"
                      // icon.style.width = "34px"
                      // icon.src = "/public/error.svg"
                      // icon.alt = "Fehlerliste"
                      // button.append(icon)

                      // const message = document.createElement("div")
                      // message.style.margin = "13px 34px"
                      // message.style.width = "100%"
                      button.right.innerHTML = /*html*/`
                        <div>${error.method}</div>
                        <div>von ${error.location}</div>
                        <div>an ${error.endpoint}</div>
                        <div><b>${error.message}</b></div>
                      `

                      // button.append(message)
                      buttons.append(button)
                    }
                    // overlay.append(buttons)
                  }


                })
              })

            }

            {
              const button = Helper.buttonPicker("left/right", buttons)
              button.left.innerHTML = ".users"
              button.right.innerHTML = "Nutzer Liste"

              button.addEventListener("click", () => {

                Helper.popup(async overlay => {
                  Helper.headerPicker("removeOverlay", overlay)
                  const info = Helper.headerPicker("info", overlay)

                  const getUsers = {}
                  getUsers.url = "/get/user/closed/2/"
                  const res = await Request.closed(getUsers)

                  if (res.status === 200) {
                    const users = JSON.parse(res.response)

                    info.innerHTML = users.length

                    const buttons = document.createElement("div")
                    buttons.style.overflowY = "scroll"
                    buttons.style.paddingBottom = "144px"
                    buttons.style.overscrollBehavior = "none"

                    for (let i = 0; i < users.length; i++) {
                      const user = users[i]

                      const button = document.createElement("div")
                      button.style.display = "flex"
                      button.style.flexWrap = "wrap"
                      button.style.alignItems = "center"
                      button.style.margin = "21px 34px"
                      button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"
                      button.style.borderRadius = "13px"
                      button.style.border = "0.3px solid black"
                      button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"

                      const icon = document.createElement("img")
                      icon.style.margin = "13px 34px"
                      icon.style.width = "34px"
                      icon.src = "/public/delete.svg"
                      icon.alt = "Löschen"
                      icon.style.cursor = "pointer"

                      icon.addEventListener("click", async () => {

                        const confirm = window.confirm("Möchten Sie wirklich diesen Nutzer löschen?")
                        if (confirm === true) {
                          const deleteUser = {}
                          deleteUser.url = "/delete/user/closed/2/"
                          deleteUser.email = user.email
                          const res = await Request.closed(deleteUser)

                          if (res.status === 200) button.remove()
                        }


                      })


                      button.append(icon)

                      const message = document.createElement("div")
                      message.style.margin = "13px 34px"
                      message.innerHTML = /*html*/`
                        <div>Email: <b>${user.email}</b></div>
                        <div>Verified: <b>${user.verified}</b></div>
                        <div>Anmeldeversuche: <b>${user.counter}</b></div>
                      `
                      message.style.cursor = "pointer"
                      message.addEventListener("click", () => {

                        Helper.popup(overlay => {
                          Helper.headerPicker("removeOverlay", overlay)

                          const buttons = Helper.create("div/scrollable", overlay)


                          {
                            const button = Helper.buttonPicker("left/right", buttons)
                            button.left.innerHTML = ".verified"
                            button.right.innerHTML = "Nutzer aktivieren/deaktivieren"
                            button.addEventListener("click", () => {
                              Helper.popup(overlay => {
                                Helper.headerPicker("removeOverlay", overlay)

                                const funnel = Helper.create("div/scrollable", overlay)

                                const verifiedField = new SelectionField("verified", funnel)
                                verifiedField.label.innerHTML = "Soll dieser Nutzer, für alle Match Maker Algorithmen, sichtbar werden"

                                if (user.verified === true) {
                                  verifiedField.options(["true", "false"])
                                }
                                if (user.verified === false) {
                                  verifiedField.options(["false", "true"])
                                }
                                verifiedField.verifyValue()

                                verifiedField.select.addEventListener("input", async () => {
                                  Helper.overlay("security", async securityOverlay => {

                                    const value = verifiedField.validValue()[0].value

                                    const register = {}
                                    register.url = "/register/verified/verified/2/"
                                    register.email = user.email
                                    if (value === "true") {
                                      register.verified = true
                                    }
                                    if (value === "false") {
                                      register.verified = false
                                    }

                                    const res = await Request.closed(register)

                                    if (res.status === 200) {
                                      window.alert("Daten erfolgreich gespeichert.")
                                      window.location.reload()
                                    }

                                    if (res.status !== 200) {
                                      Helper.redirect("session-expired")
                                    }

                                  })
                                })

                              })
                            })
                          }

                          {
                            const button = Helper.buttonPicker("left/right", buttons)
                            button.left.innerHTML = ".json"
                            button.right.innerHTML = "Nutzer Datenspiegel"
                            button.addEventListener("click", () => {
                              Helper.popup(async overlay => {
                                Helper.headerPicker("removeOverlay", overlay)
                                const info = Helper.headerPicker("info", overlay)
                                info.innerHTML = user.email

                                // const content = Helper.create("div/scrollable", overlay)
                                await Helper.render("/get/user-json/verified/2/", user.email, overlay)

                              })
                            })
                          }

                          // {
                          //   const button = Helper.buttonPicker("left/right", buttons)
                          //   button.left.innerHTML = ".delete"
                          //   button.right.innerHTML = "Nutzer entfernen"

                          //   button.addEventListener("click", async () => {

                          //     const confirm = window.confirm("Möchten Sie wirklich diesen Nutzer löschen?")
                          //     if (confirm === true) {
                          //       const deleteUser = {}
                          //       deleteUser.url = "/delete/user/closed/2/"
                          //       deleteUser.email = user.email
                          //       const res = await Request.closed(deleteUser)

                          //       if (res.status === 200) button.remove()
                          //     }


                          //   })


                          // }




                        })
                      })

                      button.append(message)
                      buttons.append(button)
                    }
                    overlay.append(buttons)
                  }




                })
              })

            }

            {
              const button = Helper.buttonPicker("left/right", buttons)
              button.left.innerHTML = ".experts"
              button.right.innerHTML = "Experten Liste"
              button.addEventListener("click", () => window.location.assign("/"))

            }

          }

        })
      })

    </script>

  </body>
</html>
