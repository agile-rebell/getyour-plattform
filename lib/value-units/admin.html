<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="/public/getyour-logo.svg" />
    <title>Admin Bereich</title>

    <style>
      body {
        margin: 0;
        line-height: 1.2;
        overscroll-behavior: none;
        font-family: sans-serif;
      }
    </style>

  </head>
  <body>

    <script type="module">
      import { Helper } from "/js/Helper.js"

      document.body.style.background = Helper.colors.light.background
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.style.background = Helper.colors.dark.background
      }

      Helper.render("text/title", "Admin", document.body)

      Helper.headerPicker("back", document.body)

      const app = Helper.headerPicker("app", document.body)
      app.addEventListener("click", () => {

        Helper.popup(async overlay => {

          const buttons = Helper.create("div/scrollable", overlay)


          {
            const button = Helper.buttonPicker("left/right", buttons)
            button.left.innerHTML = ".start"
            button.right.innerHTML = "Zugangspunkte"
            button.addEventListener("click", () => window.open("/", "_blank"))

          }

          {
            const button = Helper.buttonPicker("left/right", buttons)
            button.left.innerHTML = ".users"
            button.right.innerHTML = "Nutzer Liste"

            button.addEventListener("click", () => {

              Helper.popup(async overlay => {

                const info = Helper.headerPicker("info", overlay)

                const res = await Helper.get("list/user/admin-closed")

                if (res.status === 200) {
                  const users = JSON.parse(res.response)

                  info.innerHTML = users.length

                  const buttons = document.createElement("div")
                  buttons.style.overflowY = "scroll"
                  buttons.style.paddingBottom = "144px"
                  buttons.style.overscrollBehavior = "none"

                  for (let i = 0; i < users.length; i++) {
                    const user = users[i]

                    const button = document.createElement("div")
                    button.style.display = "flex"
                    button.style.flexWrap = "wrap"
                    button.style.alignItems = "center"
                    button.style.margin = "21px 34px"
                    button.style.backgroundColor = "rgba(255, 255, 255, 0.6)"
                    button.style.borderRadius = "13px"
                    button.style.border = "0.3px solid black"
                    button.style.boxShadow = "0 3px 6px rgba(0, 0, 0, 0.16)"

                    const icon = document.createElement("img")
                    icon.style.margin = "13px 34px"
                    icon.style.width = "34px"
                    icon.src = "/public/delete.svg"
                    icon.alt = "Löschen"
                    icon.style.cursor = "pointer"

                    icon.addEventListener("click", async () => {

                      const confirm = window.confirm("Möchten Sie wirklich diesen Nutzer löschen?")
                      if (confirm === true) {

                        const res = await Helper.delete("user/db/admin-closed", user.id)

                        if (res.status === 200) button.remove()

                        if (res.status !== 200) window.alert("Fehler.. Bitte wiederholen.")
                      }


                    })


                    button.append(icon)

                    const message = document.createElement("div")
                    message.style.margin = "13px 34px"
                    message.innerHTML = /*html*/`
                      <div>Email: <b>${user.email}</b></div>
                      <div>Verified: <b>${user.verified}</b></div>
                      <div>Anmeldeversuche: <b>${user.counter}</b></div>
                    `
                    message.style.cursor = "pointer"
                    message.addEventListener("click", () => {

                      Helper.popup(overlay => {

                        const info = Helper.headerPicker("info", overlay)
                        info.innerHTML = user.email

                        const buttons = Helper.create("div/scrollable", overlay)


                        {
                          const button = Helper.buttonPicker("left/right", buttons)
                          button.left.innerHTML = ".verified"
                          button.right.innerHTML = "Nutzer aktivieren/deaktivieren"
                          button.addEventListener("click", () => {
                            Helper.popup(overlay => {
                              Helper.headerPicker("removeOverlay", overlay)
                              const info = Helper.headerPicker("info", overlay)
                              info.innerHTML = user.email

                              const funnel = Helper.create("div/scrollable", overlay)

                              const verifiedField = Helper.create("field/select", funnel)
                              verifiedField.label.innerHTML = "Soll dieser Nutzer, für alle Match Maker Algorithmen, sichtbar werden"

                              if (user.verified === true) {
                                verifiedField.input.add(["true", "false"])
                              }
                              if (user.verified === false) {
                                verifiedField.input.add(["false", "true"])
                              }

                              Helper.verify("input/value", verifiedField.input)

                              verifiedField.input.addEventListener("input", async () => {
                                Helper.overlay("security", async securityOverlay => {

                                  const value = verifiedField.input.value

                                  const register = {}
                                  register.url = "/register/verified/verified/2/"
                                  register.email = user.email
                                  if (value === "true") {
                                    register.verified = true
                                  }
                                  if (value === "false") {
                                    register.verified = false
                                  }

                                  const res = await Helper.request("closed/json", register)

                                  if (res.status === 200) {
                                    window.alert("Daten erfolgreich gespeichert.")
                                    window.location.reload()
                                  }

                                  if (res.status !== 200) {
                                    window.alert("Fehler.. Bitte wiederholen.")
                                    Helper.remove("overlay", securityOverlay)
                                  }

                                })
                              })

                            })
                          })
                        }

                        {
                          const button = Helper.buttonPicker("left/right", buttons)
                          button.left.innerHTML = ".json"
                          button.right.innerHTML = "Nutzer Datenspiegel"
                          button.addEventListener("click", () => {
                            Helper.popup(async overlay => {
                              Helper.headerPicker("removeOverlay", overlay)
                              const info = Helper.headerPicker("info", overlay)
                              info.innerHTML = user.email

                              await Helper.render("/get/user-json/verified/2/", user.email, overlay)

                            })
                          })
                        }

                        {
                          const button = Helper.buttonPicker("left/right", buttons)
                          button.right.innerHTML = "Einzelne Datenfelder des Nutzers"
                          button.left.innerHTML = ".keys"
                          button.addEventListener("click", () => {
                            Helper.popup(async keysOverlay => {

                              const info = Helper.headerPicker("info", keysOverlay)
                              info.innerHTML = user.email
                              info.append(Helper.convert("text/span", `/keys`))

                              const content = Helper.create("info/loading", keysOverlay)

                              const res = await Helper.get("keys/user/admin-closed", user.id)

                              if (res.status === 200) {
                                const keys = JSON.parse(res.response)

                                Helper.convert("parent/scrollable", content)

                                Helper.render("user-keys/update-buttons", {user, keys}, content)

                              }


                              if (res.status !== 200) {
                                Helper.convert("parent/info", content)
                                content.innerHTML = "Keine Daten gefunden."
                              }


                            })
                          })
                        }

                      })
                    })

                    button.append(message)
                    buttons.append(button)
                  }
                  overlay.append(buttons)
                }

              })
            })

          }

          {
            const button = Helper.buttonPicker("left/right", buttons)
            button.left.innerHTML = ".logs"
            button.right.innerHTML = "Logbuch"
            button.addEventListener("click", () => {
              Helper.popup(overlay => {
                Helper.add("button/remove-overlay", overlay)

                const content = Helper.create("div/scrollable", overlay)

                {
                  const button = Helper.buttonPicker("left/right", content)
                  button.left.innerHTML = ".infos"
                  button.right.innerHTML = "Manuell gesetzter Echtzeit Logger"

                  button.addEventListener("click", () => {

                    Helper.popup(async overlay => {
                      Helper.add("button/remove-overlay", overlay)

                      await Helper.get("logs/info", overlay)

                    })

                  })

                }


                {

                  const button = Helper.buttonPicker("left/right", content)
                  button.left.innerHTML = ".errors"
                  button.right.innerHTML = "Fehler Liste"

                  button.addEventListener("click", () => {

                    Helper.popup(async overlay => {
                      Helper.add("button/remove-overlay", overlay)

                      await Helper.get("logs/error", overlay)

                    })
                  })

                }

                {
                  const button = Helper.buttonPicker("left/right", content)
                  button.left.innerHTML = ".empty"
                  button.right.innerHTML = "Logbuch leeren"

                  button.addEventListener("click", async () => {
                    const confirm = window.confirm("Möchtest du wirklich die Logbücher leeren?")

                    if (confirm === true) {

                      const res = await Helper.delete("logs/db/admin")

                      if (res.status === 200) {
                        window.alert("Logbuch wurde erfolgreich geleert.")
                      }

                      if (res.status !== 200) {
                        window.alert("Fehler.. Bitte wiederholen.")
                      }
                    }
                  })
                }



              })
            })

          }

          {
            const button = Helper.buttonPicker("left/right", buttons)
            button.left.innerHTML = ".register-expert"
            button.right.innerHTML = "Neuen Experten registrieren"

            button.addEventListener("click", () => {

              Helper.popup(async overlay => {
                Helper.headerPicker("removeOverlay", overlay)

                {
                  const funnel = Helper.create("div/scrollable", overlay)

                  const nameField = Helper.create("field/text", funnel)
                  nameField.label.innerHTML = "Name"
                  nameField.input.placeholder = "huansolo"
                  nameField.input.accept = "text/tag"
                  nameField.input.required = true
                  nameField.input.oninput = () => Helper.verify("input/value", nameField.input)
                  Helper.verify("input/value", nameField.input)

                  const emailField = Helper.create("field/email", funnel)
                  emailField.input.oninput = () => Helper.verify("input/value", emailField.input)
                  Helper.verify("input/value", emailField.input)

                  const button = Helper.buttonPicker("action", funnel)
                  button.innerHTML = "Experten jetzt registrieren"
                  button.addEventListener("click", async () => {

                    await Helper.verify("input/value", nameField.input)
                    await Helper.verify("input/value", emailField.input)

                    const username = nameField.input.value
                    const email = emailField.input.value

                    {
                      const verify = {}
                      verify.url = "/verify/expert/closed/2/"
                      verify.name = username
                      const res = await Helper.request("closed/json", verify)

                      if (res.status === 200) {
                        alert("Experte existiert bereits.")
                        Helper.setNotValidStyle(nameField.input)
                        throw new Error("expert exist")
                      }
                    }


                    Helper.overlay("security", async securityOverlay => {

                      const register = {}
                      register.url = "/register/expert/closed/2/"
                      register.name = username
                      register.email = email
                      const res = await Helper.request("closed/json", register)

                      if (res.status === 200) {
                        const send = {}
                        send.url = "/send/email/closed/2/"
                        send.email = email
                        send.event = "invite/expert"
                        const res = await Helper.request("closed/json", send)

                        if (res.status === 200) {
                          window.alert("Experte erfolgreich angemeldet.")
                          Helper.remove("overlay", overlay)
                          Helper.remove("overlay", securityOverlay)
                        } else {
                          window.alert("Anmeldung nicht möglich. Mehr Infos in den Error Logs.")
                          Helper.remove("overlay", overlay)
                          Helper.remove("overlay", securityOverlay)
                        }


                      } else {
                        alert("Anmeldung nicht möglich. Mehr Infos in den Error Logs.")
                        Helper.remove("overlay", overlay)
                        Helper.remove("overlay", securityOverlay)
                      }

                    })

                  })

                }

              })
            })
          }


        })
      })

    </script>

  </body>
</html>
